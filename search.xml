<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>愛用瀏覽器自動填入? 小心個資外洩!</title>
      <link href="2021/06/20/security-risk-of-autofill/"/>
      <url>2021/06/20/security-risk-of-autofill/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>瀏覽器能夠儲存使用者經常填入的各種資訊，舉凡帳號、密碼、Email、姓名、電話、地址、信用卡資訊…等等。</p><p>帳號密碼可能不一定會儲存，但 Email、姓名、電話之類的個資，應該很多人會選擇讓瀏覽器記憶，避免每次填寫樸實又枯燥乏味的表單要一直重複輸入。</p><p>但是在理解瀏覽器 autocomplete 觸發機制後，你還敢直接填入你的資訊嗎?</p><p>以一個只有 Email 的表單為例，你以為只有填入 Email，實際上所有紀錄的個資，都可以被心懷不軌的網站拿到。</p><p>不囉嗦，直接弄個 Demo 網站看效果: <a href="https://ryanlee.tw/security-risk-of-autofill-demo">https://ryanlee.tw/security-risk-of-autofill-demo</a></p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>瀏覽器儲存的資訊看起來很多，但其實就是三個種類，以 Chrome 為例</p><p><img src="https://i.imgur.com/qYskUcE.png" alt="Image"></p><ol><li><strong>密碼</strong>: 會綁定網站 Domain，只能夠自動填入相同網址下紀錄的帳密，所以不會發生 A 網站登入，卻填入 B 網站的帳密。</li></ol><p><img src="https://i.imgur.com/TrngHLI.png" alt="Image"></p><ol start="2"><li><strong>付款方式</strong>: 儲存信用卡資訊(卡號、到期日、持卡人姓名)，要在 https 的網站下才會觸發自動填入。</li></ol><p><img src="https://i.imgur.com/ft7dDbQ.png" alt="Image"></p><ol start="3"><li>(本文主要討論)<strong>地址和其他資訊</strong>: 國家、郵遞區號、地址、姓名、電話、Email。</li></ol><p><img src="https://i.imgur.com/i10XPqF.png" alt="Image"></p><h2 id="autocomplete"><a href="#autocomplete" class="headerlink" title="autocomplete"></a>autocomplete</h2><p>那站在開發者的角度，該如何讓瀏覽器知道 input 可以填入什麼資訊呢?</p><p>其實很簡單，就設定 input 的 <code>name</code> 或 <code>autocomplete</code> attribute 就好</p><p><img src="https://i.imgur.com/fQ8YXDo.png" alt="Image"></p><p>常見的 attribute 如下(<a href="https://developers.google.com/web/fundamentals/design-and-ux/input/forms">來源</a>):</p><table><thead><tr><th>Content type</th><th>name attribute</th><th>autocomplete attribute</th></tr></thead><tbody><tr><td>Name</td><td>name fname mname lname</td><td>name (full name)、 given-name (first name)、 additional-name (middle name)、 family-name (last name)</td></tr><tr><td>Email</td><td>email</td><td>email</td></tr><tr><td>Address</td><td>address city region province state zip zip2 postal country</td><td>For one address input: street-address、 For two address inputs: address-line1 address-line2、 address-level1 (state or province)、 address-level2 (city)、 postal-code (zip code)、 country</td></tr><tr><td>Phone</td><td>phone mobile country-code area-code exchange suffix ext</td><td>tel</td></tr><tr><td>Credit Card</td><td>ccname cardnumber cvc ccmonth ccyear exp-date card-type</td><td>cc-name cc-number cc-csc cc-exp-month cc-exp-year cc-exp cc-type</td></tr><tr><td>Usernames</td><td>username</td><td>username</td></tr><tr><td>Passwords</td><td>password</td><td>current-password (for sign-in forms)、 new-password (for sign-up and password-change forms)</td></tr></tbody></table><p>具體可看 WHATWG 制定的<a href="https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#autofill">規範</a></p><h2 id="隱藏-input"><a href="#隱藏-input" class="headerlink" title="隱藏 input"></a>隱藏 input</h2><p>文章一開始的 Demo 網站，其實也只是設定好這些屬性，然後把他們「隱藏」起來。</p><p>至於該怎麼隱藏呢?</p><p>如果你試著把 input 設為 <code>display: none</code>、<code>visibility: hidden</code>、<code>input type=&quot;hidden&quot;</code> 這幾種，會發現瀏覽器不會自動填入他們。</p><p>但如果不要這種隱藏，而是調整成只有使用者看不到的那種隱藏，就可以了XD</p><p>把框線隱藏、長寬設為 0(還是會有一小點)、設定 margin 讓他直接超出螢幕。</p><p><img src="https://i.imgur.com/TuwlhcI.png" alt="Image"></p><h2 id="危害範圍"><a href="#危害範圍" class="headerlink" title="危害範圍"></a>危害範圍</h2><p>Chrome、Edge、Safari 當你自動填入個資時，會順便填入所有能夠對應的個人資訊。</p><p>好消息是帳號密碼、付款方式各自獨立，所以不會填入。</p><p>至於 Firefox 也能夠自動填入，但它需要使用者逐個控制項選擇填入，所以不會發生上述問題。</p><p>以 Chrome 為例，根本不知道實際填入了哪些資訊</p><p><img src="https://i.imgur.com/GNmKUGi.png" alt="Image"></p><p>儘管有些瀏覽器可能會顯示實際填入的資訊，但使用者會認真停下來幾秒鐘檢查的又有多少呢?</p><p>又或者，如果有紀錄多個 Email 的情況下，跳出了詳細資訊，大多也會以為瀏覽器顯示詳細訊息，是為了讓你分辨兩筆資料的差別吧…</p><h3 id="市佔率"><a href="#市佔率" class="headerlink" title="市佔率"></a>市佔率</h3><p>以 <a href="https://netmarketshare.com/browser-market-share.aspx">Net Applications</a> 調查為例</p><p>在 Desktop 下，Chrome 的使用率接近 7 成</p><p><img src="https://i.imgur.com/jP6eZ3O.png" alt="Image"></p><p>在 Mobile 下，Chrome 的使用率也穩居 6 成</p><p><img src="https://i.imgur.com/RSFTsSA.png" alt="Image"></p><p>顯然這個問題影響著很大一部份的使用者。</p><h2 id="防範措施"><a href="#防範措施" class="headerlink" title="防範措施"></a>防範措施</h2><p>那到底該如何避免不想要的資訊被網站拿走呢?</p><ol><li>只在信任的網站自動填入</li><li>乾脆不用自動填入，或是只記錄你覺得洩漏也無所謂的資訊</li><li>使用能夠幫助你檢查表單填入資訊的瀏覽器</li><li>送出表單前，檢查網頁原始碼</li></ol><p>不過最重要的準則，還是只有一個，就是「不管帳號密碼、付款方式、個資，都只儲存你覺得洩漏也無所謂的資訊，不要覺得存在瀏覽器裡面很安全，要抱持著它總有一天會洩漏的心態來使用它」。</p>]]></content>
      
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> browser </tag>
            
            <tag> autofill </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core Model Binding 死活綁不上 - 1</title>
      <link href="2021/05/12/aspnetcore-model-binding/"/>
      <url>2021/05/12/aspnetcore-model-binding/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ASP.NET Core 的 Model Binding 基本上和 ASP.NET Framework 差不多，但實際接觸後，一開始用起來卻卡卡的XD</p><p>本文將紀錄一些當初以為理所當然，結果卻不是這麼一回事的狀況。</p><h2 id="Model-Binding"><a href="#Model-Binding" class="headerlink" title="Model Binding"></a>Model Binding</h2><p>先來科普一下~</p><p>最基本的有三個傳入來源</p><ol><li>Form</li><li>Route</li><li>Query</li></ol><p><img src="https://i.imgur.com/CRzLCcT.png" alt="Image"></p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/3vEzlK2.png"><p>可以三個都傳入，但是有其優先序<br>Form &gt; Route &gt; Query</p><p><img src="https://i.imgur.com/jtdbZzi.png" alt="Image"></p><p>可以看到結果：</p><p>透過 Form 傳入 <code>MyId1 = 1</code><br>透過 Query 參數傳入 <code>MyId1 = 3</code>, <code>MyId2 = 4</code></p><p>因為優先序的關係，MyId1 為 Form 傳入的 <strong>1</strong>，而 MyId2 因為 Form 沒有傳入，所以是吃到 Query 的 <strong>4</strong>。</p><h2 id="Binding-Attributes"><a href="#Binding-Attributes" class="headerlink" title="Binding Attributes"></a>Binding Attributes</h2><p>除了預設的三個來源，其餘皆需設定 Attribute 來指定接收來源。</p><p>但要注意，<strong>一經指定，資料就只能透過指定的方式傳入</strong>。也就是說，如果指定的 Attribute 本來就屬於預設的來源，那傳入 Attribute 指定的來源以外，也無法自動 Binding 上去。 </p><ul><li><p><code>[FromHeader]</code><br>從 HTTP Header 取值。</p></li><li><p><code>[FromForm]</code><br>從 HTTP 的 Form 取值。</p></li><li><p><code>[FromRoute]</code><br>從 MVC Route URL 取值。</p></li><li><p><code>[FromQuery]</code><br>從 URL Query 參數取值。</p></li><li><p><code>[FromBody]</code><br>從 HTTP Body 取值，通常用於取 JSON、XML。</p></li></ul><p>加入的方式可以</p><ol><li>直接在 Action 的參數前面指定</li><li>複雜型別可以到 Model 中的成員加上</li></ol><p><img src="https://i.imgur.com/80gy0XZ.png" alt="Image"></p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/WIS0mNw.png"><p>以上面的例子來說，在 MyId2 指定了 <code>[FromQuery]</code>，那就算在優先序高的 Form 中傳入 <code>MyId2 = 2</code>，也不會被影響到，而是吃 Query 傳入的 <code>MyId2 = 4</code>。</p><p><img src="https://i.imgur.com/c5MHWtF.png" alt="Image"></p><p>Q: 但如果 Query 沒有傳入 MyId2，而是只有 Form 傳入呢?</p><p>A: 如果在沒有指定 Attribute 的情況下，會吃到 Form 傳入的，但如果指定了 <code>[FromQuery]</code>，就算 Form 有傳入，也吃不到。</p><p>下圖可以看到 MyId2 沒吃到，所以回傳 int 預設的 0。</p><p><img src="https://i.imgur.com/3mcptNJ.png" alt="Image"></p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>實際開發時，最頭痛的資料來源就屬 Json 了。</p><p>為什麼頭痛，先來看看下面這個例子…</p><h3 id="複雜型別"><a href="#複雜型別" class="headerlink" title="複雜型別"></a>複雜型別</h3><p>若有兩個 Model A、B</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NameA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NameB &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以 ASP.NET Framework 來說，不管 Ajax ContentType 是 Form 還是 Json，都能夠這樣直接收</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">A a, B b</span>)</span></span><br></pre></td></tr></table></figure><p>但如果是 ASP.NET Core，要接收 Json 需要指定 <code>[FromBody]</code>，否則收不進來</p><p><img src="https://i.imgur.com/xfqZH3L.png" alt="Image"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] A a</span>)</span></span><br></pre></td></tr></table></figure><p>而且 <code>[FromBody]</code> 只能指定到一個參數上面，所以就算這樣寫，也只會把 Value 都嘗試 Bind 到 A 上</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] A a, [FromBody] B b</span>)</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Hpnzwvq.png" alt="Image"></p><h3 id="簡單型別"><a href="#簡單型別" class="headerlink" title="簡單型別"></a>簡單型別</h3><p>簡單型別透過 JSON 也只能帶一個上來</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] <span class="built_in">string</span> strA, [FromBody] <span class="built_in">string</span> strB</span>)</span></span><br></pre></td></tr></table></figure><p>這樣寫一樣綁不上去</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">        strA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        strB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/4mGvj6p.png" alt="Image"></p><p>你以為這樣就綁得上去了嗎?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify&#123;</span><br><span class="line">        strA: <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>因為不符合直接傳 string，所以名字一樣也收不了</p><p><img src="https://i.imgur.com/OcVu3gP.png" alt="Image"></p><p>要直接傳一個 string 才收的到</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(<span class="string">&quot;Bob&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/xmsrSJG.png" alt="Image"></p><p>夠難受吧，如果是多個簡單型別，別用 Json 了，直接發 Form 上來。</p><h2 id="問題-1，接收多個參數"><a href="#問題-1，接收多個參數" class="headerlink" title="問題 1，接收多個參數"></a>問題 1，接收多個參數</h2><p>那如果前端指定 Json，要傳多個參數上來，該怎麼辦呢?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    str: <span class="string">&quot;HiHi&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>把 Action 的 Model 整理成與 Request Data 一致。</p><p>維持使用 <code>[FromBody]</code> 收 JSON 的話，就要把接收的 model 調整成與 Ajax 送上來的格式一致。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">C</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> str &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> A a &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> B b &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] C c</span>)</span></span><br></pre></td></tr></table></figure><h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>接收 Json 只能有一個 <code>[FromBody]</code> 的限制，但 Form 沒有，所以在前端可以改 ContentType、而且你真的懶得再抽一個 Model 時，可以選擇不玩了，直接收 Form 就好XD</p><p>改用 <code>x-www-form-urlencoded</code> 可收多個參數（可以不用加 <code>[FromForm]</code>）。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params"><span class="built_in">string</span> str, A a, B b</span>)</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        str: <span class="string">&quot;HiHi&quot;</span>,</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>Data 的 Key 會自動去 Mapping 可能的 Model 欄位。<br>像是傳入 NameA，則會自動綁到 Model A 的 NameA。</p></blockquote><h2 id="問題-2，x-www-form-urlencoded-同名欄位-or-複雜型別"><a href="#問題-2，x-www-form-urlencoded-同名欄位-or-複雜型別" class="headerlink" title="問題 2，x-www-form-urlencoded 同名欄位 or 複雜型別"></a>問題 2，x-www-form-urlencoded 同名欄位 or 複雜型別</h2><p><code>接收多個參數</code>的問題，如果透過<code>解法二</code>處理，直接改接收 Form，那麼馬上隨之而來會有一個問題。</p><p>「平常印象中 Form 就是簡單的 key-value，沒有辦法帶 Object 格式」</p><h3 id="同名欄位"><a href="#同名欄位" class="headerlink" title="同名欄位"></a>同名欄位</h3><p>先來看看這個，如果兩個 Model 的 Name 一樣…</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">A a, B b</span>)</span></span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果是傳 Json，可能就會很自然的直接寫</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;AAA&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;BBB&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但 Form 該怎麼帶成上面那樣有階層式的阿…</p><p>如果直接傳兩個 Name 上去，結果會將第一個抓到的 Name 綁到 A 和 B 的 Name 上。</p><p><img src="https://i.imgur.com/VawRThK.png" alt="Image"></p><p>Q: Form 表單的資料格式看起來都是 key = value，該怎麼帶多個同名 key 呢?</p><p>A: 答案是可以這樣寫：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        a[Name]: <span class="string">&quot;AAA&quot;</span>,</span><br><span class="line">        b[Name]: <span class="string">&quot;BBB&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Wk4FQMS.png" alt="Image"></p><h3 id="多個複雜型別"><a href="#多個複雜型別" class="headerlink" title="多個複雜型別"></a>多個複雜型別</h3><p>甚至資料是這樣子呢?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    str: <span class="string">&quot;myStr&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;AAAAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;BBBAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Q: Form 表單的資料格式看起來都是 key = value，該怎麼帶 value 是 object 的資料呢?</p><p>A: 答案是可以這樣寫：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        a[NameA]: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        a[AModel][Address]: <span class="string">&quot;AAAAddress&quot;</span>,</span><br><span class="line">        b[NameB]: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        b[BModel][Address]: <span class="string">&quot;BBBAddress&quot;</span>,</span><br><span class="line">        str: <span class="string">&quot;myStr&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>或是這樣寫（能夠自動匹配的直接傳，同名不能的就指定參數）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel[Address]: <span class="string">&quot;AAAAddress&quot;</span>,</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel[Address]: <span class="string">&quot;BBBAddress&quot;</span>,</span><br><span class="line">        str: <span class="string">&quot;myStr&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h3><p>其實 jQuery 在發 Ajax（<code>x-www-form-urlencoded</code>） 的時候，就會自動把參數組合成上面那樣，你什麼都不用做。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myData = &#123;</span><br><span class="line">    str: <span class="string">&quot;myStr&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;AAAAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;BBBAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: myData</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>送上去的 Form Data 也會是上面範例中的型式</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Du5DHSY.png"><p>後端也能正確解析</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Fxcz1hP.png"><p>補充：如果在送出前就想要拿到這種格式，可以呼叫 <code>param</code> 函數，效果是一樣的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.param(myData)</span><br></pre></td></tr></table></figure><h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>使用了無數次 Ajax，卻不曾停下來看他一眼，趁這次也更清楚 Form 與 Json 的用法差別。</p><p>再來是 ASP.Net Core Model Binding 的資料來源</p><h3 id="ASP-NET-Core-接收-Json"><a href="#ASP-NET-Core-接收-Json" class="headerlink" title="ASP.NET Core 接收 Json"></a>ASP.NET Core 接收 Json</h3><ol><li>一個 Action 只能有一個參數掛 <code>[FromBody]</code></li><li>簡單型別盡量不要用 Json</li><li>多個複雜型別，要再向外抽一個 Model，讓他的格式完全符合前端送上來的 Json 格式</li></ol><h3 id="ASP-NET-Core-接收-Form"><a href="#ASP-NET-Core-接收-Form" class="headerlink" title="ASP.NET Core 接收 Form"></a>ASP.NET Core 接收 Form</h3><ol><li>不會受限於只能有一個參數接收 Form 來源</li><li>多個複雜型別懶得再抽一個 Model，可以考慮用一下</li></ol><p>以上資訊如有錯誤歡迎交流補充~</p><p>下一篇會再提到 ASP.NET Core 接收 Json 還有一些討厭的狀況會讓 Model 綁不上去。</p><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/models/model-binding">Model Binding in ASP.NET Core</a></p>]]></content>
      
      
      <categories>
          
          <category> Net Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Model Binding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Net Core Razor View 中文被自動編碼!?</title>
      <link href="2021/04/05/aspnetcore-chinese-encoding/"/>
      <url>2021/04/05/aspnetcore-chinese-encoding/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="View-Engine"><a href="#View-Engine" class="headerlink" title="View Engine"></a>View Engine</h2><p>使用 ASP NET Core MVC 開發時，遇到 HTML 裡的中文被進行編碼，無法正常顯示。</p><p>在找問題成因的時候，出於好奇研究了一下 ASP NET 歷史版本的更新與 View HtmlEncode 的淵源，讓我們把時間倒回 2010 年吧XD</p><p>在 ASP.NET 3.5（MVC 2） 以前，WebForm View Engine 若想要編碼 HTML 中的內容以避免 XSS 問題，需要自己呼叫編碼的方法，但是每個內容都要呼叫實在很麻煩，而且開發者也常常會忘記。</p><p><img src="https://i.imgur.com/RgIcvAq.png" alt="Image"></p><p>所幸 2011 年，ASP.NET 4（MVC 3）發佈以後，新增 <code>&lt;%: %&gt;</code> 語法來自動對內容進行 HTML 編碼，減輕了開發者的負擔與降低系統安全風險。</p><p><img src="https://i.imgur.com/EwN1ni6.png" alt="Image"></p><p>ASP.NET 4（MVC 3）版本中，也 Release 了 Razor View Engine，因為容易學習、寫法更為簡潔方便的特性，使得它逐漸成為開發 ASP.NET MVC 網站的主流（兩者具體比較可以<a href="https://www.c-sharpcorner.com/UploadFile/ff2f08/aspx-view-engine-vs-razor-view-engine/">參考</a>）。</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><h2 id="Net-Framework"><a href="#Net-Framework" class="headerlink" title="Net Framework"></a>Net Framework</h2><p>使用 Razor 在渲染畫面時，會自動進行編碼，防止 XSS。</p><blockquote><p>開發者記得不要在 View 裡面又呼叫 HtmlEncode 進行二次編碼。</p></blockquote><p>簡單來說 cshtml 裡面用到任何後端帶過來的變數，為避免造成 XSS 安全問題，Net Fx 和 Net Core 都會自動對特定符號轉碼。</p><p>EX: <code>&lt; &gt; &#39; &quot;</code></p><p><img src="https://i.imgur.com/OXm9IqG.png" alt="Image"></p><p>以下可以看到測試的結果，特定的字元都被進行轉碼。</p><p><img src="https://i.imgur.com/MmhP191.png" alt="Image"></p><h2 id="Net-Core"><a href="#Net-Core" class="headerlink" title="Net Core"></a>Net Core</h2><p>以上都沒什麼問題，但相同的測試到了 Net Core，好像有些事情不太對勁喔</p><p><img src="https://i.imgur.com/M4miOHk.png" alt="Image"></p><p>輸出的結果</p><p><img src="https://i.imgur.com/KULvD7j.png" alt="Image"></p><p>可以發現到，除了特定的字元以外，連中文都被編碼了，僅剩  abc123 正常顯示。</p><h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><p>翻了一下<a href="https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting#customizing-the-encoders">官方文件</a>真相大白</p><p><img src="https://i.imgur.com/qQH76xd.png" alt="Image"></p><p>原來 ASP.NET Core 的 Razor TagHelper 及 HtmlHelper 預設會將所有非拉丁字元都當成特殊符號進行編碼，理由是為了防範未知或未來瀏覽器針對這些字元渲染時發生的錯誤…</p><p>解決方式也很簡單，放寬預設安全字元的限制就好。</p><p>在 <code>Startup</code> 中的 <code>ConfigureServices</code> 自訂 HtmlEncoder 安全清單，加上 <code>CJK Unified Ideographs</code>。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;HtmlEncoder&gt;(</span><br><span class="line">     HtmlEncoder.Create(allowedRanges: <span class="keyword">new</span>[] &#123; UnicodeRanges.BasicLatin,</span><br><span class="line">                                               UnicodeRanges.CjkUnifiedIdeographs &#125;));</span><br></pre></td></tr></table></figure><blockquote><p>中日韓統一表意文字（英語：CJK Unified Ideographs），也稱統一漢字、統漢碼（英語：Unihan），目的是要把分別來自中文、日文、韓文、越南文、壯文、琉球文中，起源相同、本義相同、形狀一樣或稍異的表意文字，在ISO 10646及萬國碼標準賦予相同編碼。 <a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">from wiki</a></p></blockquote><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting#customizing-the-encoders">Prevent Cross-Site Scripting (XSS) in ASP.NET Core</a></p><p><a href="https://www.c-sharpcorner.com/UploadFile/abhikumarvatsa/html-encoding-in-mvc/">HTML Encoding in MVC</a></p><p><a href="https://www.c-sharpcorner.com/UploadFile/ff2f08/aspx-view-engine-vs-razor-view-engine/">ASPX View Engine VS Razor View Engine</a></p><p><a href="https://weblogs.asp.net/scottgu/new-lt-gt-syntax-for-html-encoding-output-in-asp-net-4-and-asp-net-mvc-2">HTML Encoding Output in ASP.NET 4</a></p><p><a href="https://nwpie.blogspot.com/2017/04/3-aspnet-mvc.html">ASP.NET MVC 演進歷史</a></p><p><a href="https://www.tutorialsteacher.com/mvc/asp.net-mvc-version-history">ASP.NET MVC Version History</a></p>]]></content>
      
      
      <categories>
          
          <category> Net Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cshtml </tag>
            
            <tag> encoding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Net Core 多站台共用驗證 Cookie</title>
      <link href="2021/03/10/data-protection-key/"/>
      <url>2021/03/10/data-protection-key/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>當你需要一個安全的機制來保護你的資料時，不妨可以使用 Net Core 的資料保護（Data Protection）。</p><p>他有以下特點：</p><ol><li>容易使用、擴展性高</li><li>基於非對稱的加密機制</li><li>正常情況下，不需要去設定與管理任何密鑰的儲存位置與生命週期</li></ol><p>簡單來說你想加解密資料時，可以直接使用 Data Protection 的 API：</p><ul><li>Protect</li><li>Unprotect</li></ul><p>傻瓜式(?)的使用方式，也避免開發者：</p><ol><li>搞不清楚「對稱、非對稱加密、Hash、編碼」的差異下，選擇了錯誤的方式來保護敏感資料。</li><li>自己造輪子實作加解密…</li></ol><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/introduction">ASP.NET Core 資料保護</a>、<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/using-data-protection">ASP.NET Core 中的資料保護 Api 入門</a></p></blockquote><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>在 Net Framework 時代，透過 MachineKey 來處理 Forms Authentication 的 Cookie 加解密（當然正常情況下也不會去動到 MachineKey，都交由系統處理）。</p><p>而 Net Core 雖沒有 Forms Authentication，但卻有差不多的 Cookie-based Authentication，他的 Cookie 加解密則是由上方提到的 Data Protection 機制來處理。</p><h2 id="問題-多個站台之間無法解密彼此的驗證-Cookie"><a href="#問題-多個站台之間無法解密彼此的驗證-Cookie" class="headerlink" title="問題: 多個站台之間無法解密彼此的驗證 Cookie?"></a>問題: 多個站台之間無法解密彼此的驗證 Cookie?</h2><p>「希望在網站過版時不用停機」</p><p>前陣子碰到這個需求，所以同事多建了一個站台，設定好主站台關閉後網址如何對應到備援的站台（同個網址），然後 Cookie 的 Domain 和有效期限也都有設定好，看起來需求就解決了，但實際測試時，卻有以下問題：</p><ol><li>User 在主站台已經登入的情況下使用系統</li><li>把新程式過版到備援站台</li><li>關閉主站台，讓後續流量都交由備援站台處理</li><li>User 繼續使用系統，卻是沒有登入的狀態，被導到登入畫面</li></ol><p>當下直覺是備援站台無法讀取主站台的 Cookie，後來確認了一下，一半對一半錯XD</p><p>Cookie 是可以讀取的，畢竟是同一個網址，退一步來說就算是相同 Domain 下也會讀取的到，無法讀取的是 Cookie Authentication 的驗證 Cookie。</p><p>顯然地，備援站台因為 Key 不對，無法解開主站台留下的 Cookie，所以問題收斂成需要搞懂：</p><ol><li>Data Protection 的金鑰保存在哪?</li><li>金鑰多久會過期?</li><li>我要怎麼讓不同站台共用金鑰?</li></ol><h1 id="Data-Protection-金鑰管理與生命週期"><a href="#Data-Protection-金鑰管理與生命週期" class="headerlink" title="Data Protection 金鑰管理與生命週期"></a>Data Protection 金鑰管理與生命週期</h1><p>該來的還是得來，啃了官方<del>又香又長</del>的文件。</p><h2 id="金鑰儲存位置"><a href="#金鑰儲存位置" class="headerlink" title="金鑰儲存位置"></a>金鑰儲存位置</h2><p>會依照應用程式的操作環境而有所不同：</p><ol><li>（這裡不討論）在 Azure 上會存在 <code>%HOME%\ASP.NET\DataProtection-Keys</code> 資料夾中</li><li>其餘則是除非有特別設定，否則存放在記憶體</li></ol><p>所以有個滿嚴重的問題，如果 Net Core 專案部屬在 IIS 上，應用程式集區預設的：</p><ol><li>29 小時定期回收</li><li>閒置 20 分自動終止（Terminate）</li></ol><p>或是集區手動回收，都會導致驗證的 Cookie 無法讀取。</p><p>除了驗證 Cookie 以外，只要是該機制加密的東西也會無法讀取，像是 CSRF Token。</p><blockquote><p>補充一下實驗結果，如果集區回收可以接受金鑰遺失，而閒置不想要因為後續行為遺失的話，動作由 Terminate 改為 Suspend（凍結）、或是閒置時間直接改為 0 分鐘（不終止也不凍結），則不會導致記憶體中的金鑰遺失。</p></blockquote><p>所以如果在 IIS 下想要保存金鑰，有<a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/advanced#data-protection">多種</a>設定方式，以下列兩種較方便的設定方式：</p><ol><li>建立 Data Protection Registry keys，將金鑰放在 HKLM 機碼中，並限定該集區的帳戶才能存取。</li><li>(推薦)<br>設定 IIS 應用程式集區載入使用者設定檔，金鑰會存在 <code>%LOCALAPPDATA%\ASP.NET\DataProtection-Keys</code> 資料夾中。</li></ol><h3 id="IIS-應用程式集區載入使用者設定檔"><a href="#IIS-應用程式集區載入使用者設定檔" class="headerlink" title="IIS 應用程式集區載入使用者設定檔"></a>IIS 應用程式集區載入使用者設定檔</h3><p>設定為 True 後，會將金鑰保存到上述的資料夾路徑中，也就是圖中的 xml 檔案。</p><p><img src="https://i.imgur.com/GcX1MKD.png" alt="Image"></p><p><img src="https://i.imgur.com/C7qDfxV.png" alt="Image"></p><p>裡面的內容有：</p><ol><li>建立、啟用、逾期時間（除非特別設定，否則金鑰預設的存活時間是三個月）</li><li>金鑰（在 Windows 平台下會透過 DPAPI 加密）</li></ol><p><img src="https://i.imgur.com/DrhGPLX.png" alt="Image"></p><p><strong>提醒一下，此金鑰和 MachineKey 一樣重要，千萬不能外洩!</strong></p><h1 id="接下來"><a href="#接下來" class="headerlink" title="接下來"></a>接下來</h1><p>了解 Data Protection 的金鑰管理機制後，回頭看我們的問題，還差了那麼一點，因為上面講的是單個集區保存金鑰，但多個集區（正式、備援）依舊是讀取各自保存的金鑰，只是集區回收後金鑰不會遺失而已。</p><p>所以如果要讓多個集區、或是分散式部屬的應用程式能透過 Cookie 達到 SSO 的效果，勢必得把金鑰存到這些應用都能共用的地方。</p><h1 id="自訂金鑰儲存位置"><a href="#自訂金鑰儲存位置" class="headerlink" title="自訂金鑰儲存位置"></a>自訂金鑰儲存位置</h1><p>我們可以指定金鑰存到以下位置：</p><ol><li>Azure Key Vault</li><li>File System</li><li>DB</li></ol><p>請依照專案環境選擇<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview">合適的方式</a>，像是兩個站台都建在同一台 Server 上，可以考慮存到 File System；反之可以存到 DB 比較方便。</p><h2 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h2><p>存到系統上非常簡單，如下配置後，就能夠將上述提到的 xml 存到指定路徑。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddDataProtection()</span><br><span class="line">        .PersistKeysToFileSystem(<span class="keyword">new</span> DirectoryInfo(Configuration[<span class="string">&quot;YourFilePath&quot;</span>]))</span><br><span class="line">        .SetApplicationName(<span class="string">&quot;YourApplicationName&quot;</span>);</span><br><span class="line">        <span class="comment">// 請把所有想要共用同個金鑰的應用程式都指定相同的 Application Name，</span></span><br><span class="line">        <span class="comment">// 不然就算吃到相同的金鑰，也會因為 Net Core 應用程式隔離的特性無法成功加解密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview#per-application-isolation">SetApplicationName 應用程式隔離</a></p></blockquote><h2 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h2><p>Key Storage Providers 也有<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers">常見的解決方案</a>可以選擇</p><ol><li>Entity Framework Core</li><li>Redis</li></ol><p>這邊選擇透過 EF Core 存到 DB </p><p>寫法如下：</p><ol><li><p>NuGet 下載 <code>Microsoft.AspNetCore.DataProtection.EntityFrameworkCore</code></p></li><li><p>新增一個 DbContext</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyKeysContext</span> : <span class="title">DbContext</span>, <span class="title">IDataProtectionKeyContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// A recommended constructor overload when using EF Core </span></span><br><span class="line">    <span class="comment">// with dependency injection.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyKeysContext</span>(<span class="params">DbContextOptions&lt;MyKeysContext&gt; options</span>) </span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This maps to the table that stores keys.</span></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;DataProtectionKey&gt; DataProtectionKeys &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置連線資訊與指定 PersistKeysToDbContext</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;</span><br><span class="line">        options.UseSqlServer(</span><br><span class="line">            Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add a DbContext to store your Database Keys</span></span><br><span class="line">    services.AddDbContext&lt;MyKeysContext&gt;(options =&gt;</span><br><span class="line">        options.UseSqlServer(</span><br><span class="line">            Configuration.GetConnectionString(<span class="string">&quot;MyKeysConnection&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using Microsoft.AspNetCore.DataProtection;</span></span><br><span class="line">    services.AddDataProtection()</span><br><span class="line">        .PersistKeysToDbContext&lt;MyKeysContext&gt;()</span><br><span class="line">        .SetApplicationName(<span class="string">&quot;YourApplicationName&quot;</span>);</span><br><span class="line">        <span class="comment">// 請把所有想要共用同個金鑰的應用程式都指定相同的 Application Name，不然就算吃到相同的金鑰，也會因為 Net Core 應用程式隔離的特性無法成功加解密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>migration 然後 update database 產生 DataProtectionKeys 的 Table</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add AddDataProtectionKeys --context MyKeysContext</span><br><span class="line">dotnet ef database update --context MyKeysContext</span><br></pre></td></tr></table></figure></li></ol><p>存到 DB 其實只是把 xml 內容存進去而已，沒有做特別改動</p><p><img src="https://i.imgur.com/twJWzAv.png" alt="Image"></p><h2 id="DB-First-解決方法"><a href="#DB-First-解決方法" class="headerlink" title="DB First 解決方法"></a>DB First 解決方法</h2><p>基本上就是這樣，如果有問題的話大概就是第四步，因為我們專案 EF Core 是採 DB First 形式，還是可以解決，只是會有兩種方法：</p><ol><li>可以的話直接 migration 然後 update database，長出 DataProtectionKeys 的 Table 之後，把所有 migration 相關的資料夾、檔案、Table 都刪除。</li><li>如果不能用程式動 Table 的話，可以把 DataProtectionKeys 的 Table 寫成 SQL Script 來給相關人員 Create。</li></ol><p><img src="https://i.imgur.com/48rFEDp.png" alt="Image"></p><p>這邊附上 SQL Server + SSMS 直接產生的 Script，使用前請先確認你使用的 DB 語法有沒有正確。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IF  EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.objects <span class="keyword">WHERE</span> object_id = OBJECT_ID(N<span class="string">&#x27;[dbo].[DataProtectionKeys]&#x27;</span>) <span class="keyword">AND</span> <span class="keyword">type</span> <span class="keyword">in</span> (N<span class="string">&#x27;U&#x27;</span>))</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [dbo].[DataProtectionKeys]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[DataProtectionKeys](</span><br><span class="line">[<span class="keyword">Id</span>] [<span class="built_in">int</span>] <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[FriendlyName] [<span class="keyword">nvarchar</span>](<span class="keyword">max</span>) <span class="literal">NULL</span>,</span><br><span class="line">[<span class="keyword">Xml</span>] [<span class="keyword">nvarchar</span>](<span class="keyword">max</span>) <span class="literal">NULL</span>,</span><br><span class="line"> <span class="keyword">CONSTRAINT</span> [PK_DataProtectionKeys] PRIMARY <span class="keyword">KEY</span> CLUSTERED </span><br><span class="line">(</span><br><span class="line">[<span class="keyword">Id</span>] <span class="keyword">ASC</span></span><br><span class="line">)<span class="keyword">WITH</span> (PAD_INDEX = <span class="keyword">OFF</span>, STATISTICS_NORECOMPUTE = <span class="keyword">OFF</span>, IGNORE_DUP_KEY = <span class="keyword">OFF</span>, ALLOW_ROW_LOCKS = <span class="keyword">ON</span>, ALLOW_PAGE_LOCKS = <span class="keyword">ON</span>) <span class="keyword">ON</span> [PRIMARY]</span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure><h2 id="金鑰加密"><a href="#金鑰加密" class="headerlink" title="!!金鑰加密!!"></a>!!金鑰加密!!</h2><p>只要指定金鑰的儲存位置，不管是存到 File System 還是 DB，Net Core 都不會把金鑰加密，因為他不知道 DPAPI 是否為適當的加密機制，所以如果有改變儲存位置，記得選擇適當的加密方式。</p><ol><li>DPAPI（Windows Only）</li><li>X.509 憑證</li><li>自訂</li></ol><p>若以保存到 File System 為例，XML 打開會看到警示: <code>Warning: the key below is in an unencrypted form.</code>。</p><p><img src="https://i.imgur.com/eMJxVp0.png" alt="Image"></p><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest">NET Core 的待用金鑰加密</a></p></blockquote><h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>我最後選擇透過 EF Core 將金鑰存到 DB，設定共用的金鑰後，也成功讓正式與備援站台讀取彼此的驗證 Cookie 達到不停機過版的效果，當然未來如果 I/O 遇到效能瓶頸，可能會考慮存到 Redis。</p><p>礙於篇幅與實用性，沒有講到全部的細節，故在文中都有穿插連結，不管是有興趣的人還是想要自己處理金鑰的人，都建議閱讀。</p><p>文中內容若有錯誤的地方，請不吝告知。</p><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview">設定 ASP.NET Core 資料保護</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest">Windows 和 Azure 中使用 ASP.NET Core 的待用金鑰加密</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers">ASP.NET Core 中的金鑰儲存提供者</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/default-settings">ASP.NET Core 中的資料保護金鑰管理和存留期</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/advanced?view=aspnetcore-5.0#data-protection">ASP.NET Core 模組和 IIS 的 Advanced configuration</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cookie-sharing">cookie在 ASP.NET apps 之間共用驗證</a></p><p><a href="https://medium.com/swlh/how-to-distribute-data-protection-keys-with-an-asp-net-core-web-app-8b2b5d52851b">How to distribute Data Protection keys with an ASP.NET Core web app</a></p><p><a href="https://blog.darkthread.net/blog/inside-aspnet-autogenkeys/">ASP.NET MachineKey自動產生原理剖析</a></p><p><a href="https://www.cnblogs.com/savorboard/p/5778616.html">ASP.NET Core 数据保护（Data Protection）【上】</a></p><p><a href="https://www.cnblogs.com/liang24/p/13925057.html">ASP.NET Core Authentication系列（四）基于Cookie实现多应用间单点登录（SSO）</a></p>]]></content>
      
      
      <categories>
          
          <category> Net Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Data Protection </tag>
            
            <tag> Cookie </tag>
            
            <tag> SSO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TickTick 待辦事項與行事曆結合 - 基本使用指南</title>
      <link href="2020/12/06/ticktick-startup/"/>
      <url>2020/12/06/ticktick-startup/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>對於待辦事項，之前一直沒有好的方式來管理，最早是嘗試使用行事曆，也就是把待辦事項都當成行程放在裡面，但這會有三個問題:</p><ol><li>有些任務是沒有時間概念、或是急迫性的，也就是什麼時候做都可以</li><li>任務之間會有不同的大分類，Ex: 個人、工作，沒辦法很好的分開他們</li><li>行事曆沒辦法一目瞭然的看到所有 ToDoList，所有任務都和日期格子混在一起，導致時間久了，非常懶得開</li></ol><p>後來有嘗試 Google Keep + Google Calandar，這個其實很接近我想要的管理方式了</p><ol><li>任務都放在 Google Keep 上，很簡單就能夠管理</li><li>有需要時間概念的，就把任務壓上提醒時間</li></ol><p>但這還是有四個問題</p><ol><li>行事曆仍然與待辦事項分開，要用兩個 App</li><li>待辦事項用 Google Keep 有時過於陽春，缺乏良好的管理與搜尋方式</li><li>Google Keep 在 IOS 上的體驗非常不好 (截至 2020/12/06)，每次開啟 App 都會停頓個幾秒，好像是在同步，然後便籤很容易誤觸打開或關閉，拖動 Task 也常常卡頓</li><li>缺乏 Kanban 概念，沒辦法像 Trello 那樣把較複雜的任務，視覺化的拖動來控制任務狀態，Ex: Todo、In Progress、Resolved…</li></ol><p>後來有查了一些熱門的待辦事項解決方案</p><ul><li>Todoist<ul><li>跨平台、訂閱制，免費方案沒有提醒功能</li></ul></li><li>TickTick<ul><li>跨平台、訂閱制，免費方案有提醒功能 + 週行事曆</li></ul></li><li>Trello + 行事曆<ul><li>跨平台、但沒辦法一個 App 搞定</li></ul></li><li>OmniFocus (IOS)<ul><li>功能非常完整，但介面複雜、太麻煩、價格太高</li></ul></li></ul><p>經過簡單評估與試用了 Todoist、TickTick 後，覺得 TickTick 完美符合了我的需求XD</p><p>但 TickTick 有中資背景，會介意的三思</p><h1 id="正文開始"><a href="#正文開始" class="headerlink" title="正文開始"></a>正文開始</h1><p>基本操作就不再介紹了，應該簡單到下載安裝好就會使用，第一次使用也會有新手教學。</p><p>以下會直接以<strong>實際情境</strong>來介紹</p><h2 id="分組"><a href="#分組" class="headerlink" title="分組"></a>分組</h2><p>能夠建立好幾個清單來分開 <strong>個人</strong> 與 <strong>工作</strong> 的待辦事項</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/e00YuXh.jpg"><h2 id="待辦清單"><a href="#待辦清單" class="headerlink" title="待辦清單"></a>待辦清單</h2><p>待辦清單除了標題以外，也可以在補充一些內容，或是子任務</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/3ozLMgr.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/sTqqAME.jpg"><h2 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h2><p>這個有點像心得總結，你可以新增一個非待辦事項的筆記，用來總結一週心得或是任何你想記錄的</p><p>第一張圖片裡面，我就為每個分組都新增了一個 Notes 清單</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/D3Is1fC.jpg"><h2 id="Kanban"><a href="#Kanban" class="headerlink" title="Kanban"></a>Kanban</h2><p>除了條列式的呈現待辦事項以外，也可以切換其他看板模式，達到 Kanban 管理<strong>有狀態</strong>的任務效果。</p><p>我是把 Work 的 List 改成看板而已，因為 Work 的事項有時候比較沒有辦法短時間就完成，但還是要紀錄已經開始處理。</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/MytQ6LZ.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/HHgTNpc.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/7lbRVWX.jpg"><h2 id="Calendar"><a href="#Calendar" class="headerlink" title="Calendar"></a>Calendar</h2><p>免費版只能使用<strong>週行事曆</strong>而以，需要更詳細的功能可以付費支持。</p><p>行事曆可以一目瞭然的顯示「幾月幾號有什麼事情要做」</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/P0LauKM.jpg"><h3 id="同步其他行事曆"><a href="#同步其他行事曆" class="headerlink" title="同步其他行事曆"></a>同步其他行事曆</h3><p>若有其他行事曆，Ex: iPhone / Google 行事曆，也可以把上面的任務同步進 TickTick</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/YEh5zkQ.jpg"><h2 id="Smart-List"><a href="#Smart-List" class="headerlink" title="Smart List"></a>Smart List</h2><p>上面範例使用了 Work + Personal + Blog 三個清單，若要知道今天或明天總共有哪些待辦事項，不需要每個清單查看，可以到預設的智慧清單查看就好，Ex: 今天、明天、未來 7 天…etc，會幫你統整所有 List 在當天需要做的事情。</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/XdjaPqr.jpg"><h2 id="Desktop"><a href="#Desktop" class="headerlink" title="Desktop"></a>Desktop</h2><p>TickTick 支援: Web、Windows、Mac、IOS、Android</p><p>若在電腦使用，我建議安裝軟體，而不是使用 Webapp，好處有</p><ol><li>可設定開機自動啟動，Webapp 87% 的機率你過一陣子就不會去開他</li><li>提醒方式更加友善</li><li>看板拖拉更直覺</li><li>可設定桌面懸浮</li></ol><p><img src="https://i.imgur.com/VpyDeAb.jpg"></p><p>桌面懸浮可以新增、顯示待辦事項，若不需要使用也會自動縮合在螢幕邊緣，非常實用</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Gvkitkh.png"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/POKIs05.jpg"><h2 id="附註"><a href="#附註" class="headerlink" title="附註"></a>附註</h2><p>其他還有番茄鐘、打卡養成習慣等功能，若有興趣的也可以自行研究。</p><p>自己是有在電腦使用番茄鐘，還滿方便的，也不用另外在裝軟體或套件，蕃茄鐘也能夠把執行的時間紀錄給某個任務，然後可以到統計圖表查看處理任務花了多少時間。</p><h1 id="碎念"><a href="#碎念" class="headerlink" title="碎念"></a>碎念</h1><p>以上範例都有解決了我的需求</p><ol><li>簡單管理任務</li><li>結合行事曆</li><li>單一 App</li><li>提醒功能</li><li>心得紀錄</li><li>看板功能</li></ol><p>若有類似需求，或是腦袋已經不堪現實的摧殘，需要助手來幫你管理待辦事項的，強力推薦可以嘗試使用XD</p><h2 id="GTD"><a href="#GTD" class="headerlink" title="GTD"></a>GTD</h2><p>如果想要更進階的流程，像是用 GTD（Getting Things Done）的精神來管理，我覺得 TickTick 也是能夠勝任的。</p><p>像是一開始的蒐集階段，TickTick 就有一個收集箱來讓你放</p><ul><li>靈感突發想到的事情，但還不想分類</li><li>瑣碎但還不足以執行的想法</li><li>etc…</li></ul><p>週任務也能夠新增 List 來解決，每週的檢討也能放在 Notes 裡面，這部分就留給讀者自行研究了。</p><p><img src="https://i.imgur.com/753PDvM.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> ToDoList </category>
          
          <category> TickTick </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TickTick </tag>
            
            <tag> ToDoList </tag>
            
            <tag> Kanban </tag>
            
            <tag> Calendar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 建站心得</title>
      <link href="2020/11/30/hexo-note/"/>
      <url>2020/11/30/hexo-note/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>原本以為用 Hexo、挑個 Theme，之後把 Blog 建起來應該不會遇到什麼問題，也不用特別記錄下來，但…事與願違XD</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>我用的主題是 <a href="https://github.com/jerryc127/hexo-theme-butterfly">butterfly</a>，理論上只要把裡面文檔都看過就能解決 90% 的問題，也不太需要看<a href="https://hexo.io/zh-tw/docs/">官方文檔</a>，弄好之後放在 Github Page，然後前面掛個 Cloudflare。</p><p>Hexo 大致設定</p><ul><li>Disqus / Facebook Comments</li><li>PWA</li><li>Custom Pagination、Footer</li><li>Edit Scaffolds</li></ul><p>Cloudflare 大致設定</p><ul><li>SSL、Always Use HTTPS、Automatic HTTPS Rewrites</li><li>Auto Minify、Cache、Always Online</li></ul><p>SEO 大致處理</p><ul><li>Sitemap、Robots.txt</li><li>Nofollow</li><li>Submit to Google Search Console</li></ul><p>科普知識就不提了，網路上已經很多詳細的文章</p><ul><li>What ‘s Hexo and Why</li><li>What’s Markdown</li><li>How to deploy to Github Page</li><li>How to use your custom domain and How to buy</li><li>What’s SSL</li><li>etc…</li></ul><p>以下會列出當時有遇到的一些問題。</p><h2 id="Pagination-預設-Style-以圖片為背景"><a href="#Pagination-預設-Style-以圖片為背景" class="headerlink" title="Pagination 預設 Style 以圖片為背景"></a>Pagination 預設 Style 以圖片為背景</h2><p><img src="https://imgur.com/ZciUF7y.png"><br><a href="https://jerryc.me/posts/21cfbf15/">圖片來源</a></p><p>主題預設每個 Post 都會有一個封面圖片，如果不想要可以去設定檔拿掉，但拿掉圖片，上/下一頁連結就變成高度很高，但背景是白的連結了。</p><p>只想要單純的文字，像這樣的話</p><p><img src="https://imgur.com/PfZNzxO.png"></p><p>要直接改 <code>themes\butterfly\layout\includes\pagination.pug</code></p><p>以下節錄我調整後的程式碼，以可以調整成自己喜歡的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if(page.prev)</span><br><span class="line">    - var hasPageNext &#x3D; page.next ? &#39;pull-left&#39; : &#39;pull-full&#39;</span><br><span class="line">    .prev-post(class&#x3D;hasPageNext)</span><br><span class="line">        a(href&#x3D;url_for(page.prev.path))</span><br><span class="line">            .pagination-info</span><br><span class="line">                .i.fa.fa-chevron-circle-left</span><br><span class="line">                .prev_info&#x3D;page.prev.title</span><br><span class="line">          </span><br><span class="line">if(page.next)</span><br><span class="line">    - var hasPagePrev &#x3D; page.prev ? &#39;pull-right&#39; : &#39;pull-full&#39;</span><br><span class="line">    .next-post(class&#x3D;hasPagePrev)</span><br><span class="line">        a(href&#x3D;url_for(page.next.path))</span><br><span class="line">            .pagination-info</span><br><span class="line">                .i.fa.fa-chevron-circle-right</span><br><span class="line">                .next_info&#x3D;page.next.title </span><br></pre></td></tr></table></figure><h2 id="Facebook-Comments"><a href="#Facebook-Comments" class="headerlink" title="Facebook Comments"></a>Facebook Comments</h2><h3 id="超級無敵大雷1"><a href="#超級無敵大雷1" class="headerlink" title="超級無敵大雷1"></a>超級無敵大雷1</h3><p>我網站主題是深色(Dark)，但 FaceBook Comments Dark Theme 目前壞掉，只能透過 CSS 把評論區塊背景設為白色，不然會完全看不到字 (Disqus 沒這個問題)。</p><p><img src="https://imgur.com/zGv7BAv.png"></p><p>看起來和 Hexo 無關，是 Facebook 的問題、也有人 2020/08/12 回報了，雖然進度上寫處理完畢，但我 2020/11/30 測試起來問題仍在。</p><p><a href="https://developers.facebook.com/support/bugs/1759174414250782/">https://developers.facebook.com/support/bugs/1759174414250782/</a></p><p><img src="https://i.imgur.com/6QZkv1C.png"></p><p>不想放棄 Facebook Comments + 深色主題的話，我的解法是把 Facebook 的 Comment 區塊直接背景變白色XD</p><p><code>themes\butterfly\source\css\_layout\comments.styl</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.comment-wrap</span><br><span class="line">    &gt; div:nth-child(2)</span><br><span class="line">        background-color: white !important;</span><br><span class="line">        border-radius: 5px !important;</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/STYzbcG.png"></p><p>而 Disqus 則維持原本正常的深色主題</p><p><img src="https://i.imgur.com/tfiVAJ1.png"></p><h3 id="超級無敵大雷2"><a href="#超級無敵大雷2" class="headerlink" title="超級無敵大雷2"></a>超級無敵大雷2</h3><p>原本以為這樣就高枕無憂，但 2020/11/30 的 IOS 不管是 Chrome 還是 Safari 都無法透過 Facebook Comments 留言，但桌面版、Android 的可以正常留言…</p><p>狀況有2</p><ol><li>明明已經有登入 Facebook，但留言區抓不到，一樣要登入，可是點了登入之後就瘋狂無限白畫面跳轉。</li><li>留言框自己不斷重整，無法選取打字。</li></ol><p>以上問題測試了 3 台 iPhone 都是這樣QQ，一開始以為是我哪裡沒處理好，但到幾個新聞網站 (水果、聯X) 的留言區測試，發現一樣有這些問題…，這個狀況目前無解。</p>]]></content>
      
      
      <categories>
          
          <category> Blog </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Butterfly </tag>
            
            <tag> Facebook Comment </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

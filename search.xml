<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>LeetCode 筆記 - Array</title>
      <link href="2022/10/26/leetcode-array/"/>
      <url>2022/10/26/leetcode-array/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>訂了個目標，接下來的兩個月，每天會刷個一、兩題 leetcode，難度由淺入深，保持解題手感，順便複習資料結構與演算法。</p><p>然後還會寫一篇筆記，內容大致為</p><ul><li>題目</li><li>知識點</li><li>解法</li><li>遇到的問題</li></ul><p>但考量到每天可支配的時間不是固定的，若時間緊湊，文章就會是簡單紀錄心得而已，有剩餘時間會再把內容寫詳細一點XD</p><blockquote><p>刷題預計會使用 C#。</p></blockquote><h1 id="題目"><a href="#題目" class="headerlink" title="題目"></a>題目</h1><ul><li>704: Binary Search</li><li>27: Remove Element</li></ul><h2 id="704-Binary-Search"><a href="#704-Binary-Search" class="headerlink" title="704. Binary Search"></a>704. Binary Search</h2><p><a href="https://leetcode.com/problems/binary-search">https://leetcode.com/problems/binary-search</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Given an array of integers nums which is sorted in ascending order, and an integer target, write a function to search target in nums. If target exists, then return its index. Otherwise, return -1.</span><br><span class="line"></span><br><span class="line">You must write an algorithm with O(log n) runtime complexity.</span><br></pre></td></tr></table></figure><p>Example1:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [-1,0,3,5,9,12], target &#x3D; 9</span><br><span class="line">Output: 4</span><br><span class="line">Explanation: 9 exists in nums and its index is 4</span><br></pre></td></tr></table></figure><p>Example2:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [-1,0,3,5,9,12], target &#x3D; 2</span><br><span class="line">Output: -1</span><br><span class="line">Explanation: 2 does not exist in nums so return -1</span><br></pre></td></tr></table></figure><p>Constraints:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 1 &lt;&#x3D; nums.length &lt;&#x3D; 104</span><br><span class="line">- -104 &lt; nums[i], target &lt; 104</span><br><span class="line">- All the integers in nums are unique.</span><br><span class="line">- nums is sorted in ascending order.</span><br></pre></td></tr></table></figure><h2 id="知識點"><a href="#知識點" class="headerlink" title="知識點"></a>知識點</h2><p>雖然題目直接寫明了 binary search，但在使用時還是得注意</p><ol><li>array 是否已經排序?</li><li>array 是否有重複元素?</li></ol><p>再來要思考的就是邊界條件到底要怎麼寫?</p><ol><li>left index 與 right index 要用<code>小於</code>還是<code>小於等於</code>?</li><li>middle value &gt; target 時，right index 要改為 <code>middle</code> 還是 <code>middle - 1</code>?</li><li>middle value &lt; target 時，right index 要改為 <code>middle</code> 還是 <code>middle + 1</code>?</li></ol><p>簡單來說，如果 index 區間是 <code>[left, right]</code>，則</p><ul><li>middleValue &gt; targetValue 時，<code>rightIndex = middle - 1</code>，因為當下之 middleValue 已經不會是 targetValue 了，所以下一輪的 right 邊界不用在包含它。</li><li>middleValue &lt; targetValue 時，<code>leftIndex = middle + 1</code>，因為當下之 middleValue 已經不會是 targetValue 了，所以下一輪的 left 邊界不用在包含它。</li></ul><p>反之若 index 區間是 <code>[left, right)</code>，則</p><ul><li>middleValue &gt; targetValue 時，因為右邊界不包含，<code>rightIndex = middle</code>。</li><li>middleValue &lt; targetValue 時，<code>leftIndex = middle + 1</code>。</li></ul><h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><h3 id="First"><a href="#First" class="headerlink" title="First"></a>First</h3><p>個人比較習慣 <code>[left, right]</code> 的寫法。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Search</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> left = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> right = nums.Count() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (left &lt;= right)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> middle = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (nums[middle] &gt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            right = middle - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[middle] &lt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            left = middle + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> middle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Second"><a href="#Second" class="headerlink" title="Second"></a>Second</h3><p>另外一個是 <code>[left, right)</code> 的版本</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Search</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> left = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> right = nums.Count();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (left &lt; right)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> middle = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (nums[middle] &gt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            right = middle;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[middle] &lt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            left = middle + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> middle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="27-Remove-Element"><a href="#27-Remove-Element" class="headerlink" title="27: Remove Element"></a>27: Remove Element</h2><p><a href="https://leetcode.com/problems/remove-element/">https://leetcode.com/problems/remove-element/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Given an integer array nums and an integer val, remove all occurrences of val in nums in-place. The relative order of the elements may be changed.</span><br><span class="line"></span><br><span class="line">Since it is impossible to change the length of the array in some languages, you must instead have the result be placed in the first part of the array nums. More formally, if there are k elements after removing the duplicates, then the first k elements of nums should hold the final result. It does not matter what you leave beyond the first k elements.</span><br><span class="line"></span><br><span class="line">Return k after placing the final result in the first k slots of nums.</span><br><span class="line"></span><br><span class="line">Do not allocate extra space for another array. You must do this by modifying the input array in-place with O(1) extra memory.</span><br></pre></td></tr></table></figure><p>Example 1:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [3,2,2,3], val &#x3D; 3</span><br><span class="line">Output: 2, nums &#x3D; [2,2,_,_]</span><br><span class="line">Explanation: Your function should return k &#x3D; 2, with the first two elements of nums being 2.</span><br><span class="line">It does not matter what you leave beyond the returned k (hence they are underscores).</span><br></pre></td></tr></table></figure><p>Example 2:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [0,1,2,2,3,0,4,2], val &#x3D; 2</span><br><span class="line">Output: 5, nums &#x3D; [0,1,4,0,3,_,_,_]</span><br><span class="line">Explanation: Your function should return k &#x3D; 5, with the first five elements of nums containing 0, 0, 1, 3, and 4.</span><br><span class="line">Note that the five elements can be returned in any order.</span><br><span class="line">It does not matter what you leave beyond the returned k (hence they are underscores).</span><br></pre></td></tr></table></figure><p>Constraints:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 &lt;&#x3D; nums.length &lt;&#x3D; 100</span><br><span class="line">0 &lt;&#x3D; nums[i] &lt;&#x3D; 50</span><br><span class="line">0 &lt;&#x3D; val &lt;&#x3D; 100</span><br></pre></td></tr></table></figure><blockquote><p>ps. 不需要考慮陣列中超出新長度後面的元素。</p></blockquote><h2 id="知識點-1"><a href="#知識點-1" class="headerlink" title="知識點"></a>知識點</h2><p>要記得 array 在記憶體中的位址是連續的，不能單獨刪除陣列中的某個元素，只能覆寫。</p><h2 id="解法-1"><a href="#解法-1" class="headerlink" title="解法"></a>解法</h2><h3 id="暴力法"><a href="#暴力法" class="headerlink" title="暴力法"></a>暴力法</h3><p>時間複雜度: <code>O(n^2)</code><br>空間複雜度: <code>O(1)</code></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">RemoveElement</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> val</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> count = nums.Count();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i] == val)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 找到需要移除的元素，將其餘元素往前移動一位</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = i; j &lt; count - <span class="number">1</span>; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// j &lt; count - 1: 當最後一個元素往前移，則原本意義上的最後一個元素就不處理了</span></span><br><span class="line">                nums[j] = nums[j + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 因為元素往前一位，所以 i 也往前一位</span></span><br><span class="line">            i--;</span><br><span class="line">            <span class="comment">// 陣列數量 - 1</span></span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="雙指針法"><a href="#雙指針法" class="headerlink" title="雙指針法"></a>雙指針法</h3><p>時間複雜度: <code>O(n)</code><br>空間複雜度: <code>O(1)</code></p><p>可以理解為，建立一個新陣列(實際使用同一個)，並且在迭代過程中將 <code>val</code> 以外的元素都依序放入這個新陣列。<br><code>新陣列</code>(實際使用同一個)使用的 index 為 <code>slowIndex</code>，從 0 開始，並且只有在寫入元素後才會 + 1。<br><code>舊陣列</code>(實際使用同一個)使用的 index 為 <code>fastIndex</code>，如果當前值不等於 <code>val</code>，則會將該值(<code>nums[fastIndex]</code>)放入新陣列。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">RemoveElement</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> val</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> slowIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> fastIndex = <span class="number">0</span>; fastIndex &lt; nums.Count(); fastIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[fastIndex] != val)</span><br><span class="line">        &#123;</span><br><span class="line">            nums[slowIndex] = nums[fastIndex];</span><br><span class="line">            <span class="comment">// 只有在寫入新值時才會 + 1</span></span><br><span class="line">            slowIndex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slowIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> LeetCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> binary-search </tag>
            
            <tag> remove-element </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET 專案設定多個目標框架</title>
      <link href="2022/07/22/targetframeworks-setting/"/>
      <url>2022/07/22/targetframeworks-setting/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>遇到一個需求是要建立兩個不同版本的 Web API 進行測試，他們會參考到某個類別庫 A。</p><p>但為了嚴謹性，希望 NET 6 參考到的類別庫也是使用 NET 6，而不是較低的版本如 NET 3.1 或 NET Standard；反之 NET 3.1 的 Web API 也是希望使用框架目標為 NET 3.1 的類別庫 A。</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>簡單紀錄一下調整的過程。</p><h2 id="調整-csproj"><a href="#調整-csproj" class="headerlink" title="調整 csproj"></a>調整 csproj</h2><p>打開類別庫 A 的 csproj</p><blockquote><p>Tips: 在 VS 中可以直接在方案總管中對專案點兩下打開 csproj 設定檔。</p></blockquote><p>將 TargetFramework 加上「s」，然後就可以在「;」後面加上想要支援的版本。</p><blockquote><p>引用該類別庫的專案，會自動選擇能夠兼容的最高版本。</p><p>例如: NET 6 API 專案引用類別庫時，雖然可以用 NET 3.1 也可以用 NET 6，但會自動選擇 NET 6。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;PropertyGroup&gt;</span><br><span class="line">    &lt;TargetFrameworks&gt;netcoreapp3.1;net6.0&lt;&#x2F;TargetFrameworks&gt;</span><br><span class="line">&lt;&#x2F;PropertyGroup&gt;</span><br></pre></td></tr></table></figure><p>具體可用的版本號可參考 <a href="https://docs.microsoft.com/en-us/dotnet/standard/frameworks#supported-target-frameworks">supported-target-frameworks</a></p><p>調整後 build 出的兩個版本</p><p><img src="https://i.imgur.com/XutLuQk.png" alt="Image"></p><h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>如果不同的 .NET 版本想引用不同的套件，或者是某些套件只能在特定的 .NET 版本上運行時，也可以在 csporj 裡面設定 PackageReference。</p><p>例如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ItemGroup Condition&#x3D;&quot;&#39;$(TargetFramework)&#39; &#x3D;&#x3D; &#39;net6.0&#39;&quot;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.Common.Context&quot; Version&#x3D;&quot;6.0.0&quot; &#x2F;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.Common.Values&quot; Version&#x3D;&quot;6.0.0&quot; &#x2F;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.AccessLog.EFCore&quot; Version&#x3D;&quot;6.0.0&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;ItemGroup&gt;</span><br><span class="line"></span><br><span class="line">&lt;ItemGroup Condition&#x3D;&quot;&#39;$(TargetFramework)&#39; &#x3D;&#x3D; &#39;netcoreapp3.1&#39;&quot;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.Common.Context&quot; Version&#x3D;&quot;1.5.0&quot; &#x2F;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.Common.Values&quot; Version&#x3D;&quot;1.6.0&quot; &#x2F;&gt;</span><br><span class="line">    &lt;PackageReference Include&#x3D;&quot;Data.AccessLog.EFCore&quot; Version&#x3D;&quot;1.7.0&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;ItemGroup&gt;</span><br></pre></td></tr></table></figure><h2 id="Conditional-compilation"><a href="#Conditional-compilation" class="headerlink" title="Conditional compilation"></a>Conditional compilation</h2><p>如果某些 Code 只想在某個版本上的 NET 上跑，可以使用預處理器指示詞來控制<a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives#conditional-compilation">條件式編譯</a>。</p><p>例如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public string Platform &#123;</span><br><span class="line">   get &#123;</span><br><span class="line">#if NET6_0</span><br><span class="line">      return &quot;.NET 6&quot;</span><br><span class="line">#elif NETCOREAPP3_1</span><br><span class="line">      return &quot;.NET 3&quot;</span><br><span class="line">#else</span><br><span class="line">#error This code block does not match csproj TargetFrameworks list</span><br><span class="line">#endif</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更多前置處理器符號可參考 <a href="https://docs.microsoft.com/en-us/dotnet/core/tutorials/libraries#preprocessor-symbols">Preprocessor Symbols</a>。</p>]]></content>
      
      
      <categories>
          
          <category> ASP.NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> targetframeworks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>關於談判二三事</title>
      <link href="2022/07/19/negotiation/"/>
      <url>2022/07/19/negotiation/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>這半年來因為工作與房子的事情有了許多「談判」的機會，原本以為自己還算會溝通，但直到坐上「談判桌」才發現談判與溝通能力完全是兩碼子事，不會談判的自己在當下如同誤入叢林的小綿羊，沒有任何保護自己的能力，或者是說，也不知道該如何保護自己。</p><p>日前拜讀了劉必榮教授的談判技巧，受益良多，過程中紀錄了一些談判原則想要分享給和我一樣沒什麼談判經驗的讀者。</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><blockquote><ol><li>本文沒有任何商業合作，僅是個人筆記分享，如有侵權請告知。</li><li>接下來的內容會以條列的形式呈現，不會脈絡化的解釋每個原則。</li></ol></blockquote><h2 id="關於談判"><a href="#關於談判" class="headerlink" title="關於談判"></a>關於談判</h2><ul><li>談判本質是交換，不是贏者全拿、輸者全輸。</li><li>辯論贏對方的嘴、談判贏對方的心。</li><li>談判只是解決問題的方式，不用拿出上戰場殺敵的氣勢。</li></ul><h2 id="談判的人與事"><a href="#談判的人與事" class="headerlink" title="談判的人與事"></a>談判的人與事</h2><ul><li>搞清楚雙方各自要的是什麼。<ul><li>What do you want?</li></ul></li><li>（承上）列出<ul><li>must：你不能讓步的。</li><li>want：你想要的，但可以視情況用來交換或放棄。</li><li>give：可有可無、給對方也無所謂。</li></ul></li><li>搞清楚要跟誰談，一家公司裡面，不同的人要談不同的東西。</li><li>A 和 B 有交情，和 A 談沒籌碼，可以想辦法把 B 拉進來。<ul><li>牽扯多方的時候，若對方內部有衝突，不要亂同情、表態，有些東西是不能搭話的。</li></ul></li><li>視情況把「情」加進去，搞清楚關係是「助力」還是「阻力」，關係是「手段」還是「目的」。</li><li>人和事是相互影響的，人會帶進事，事會帶進人，人、事一改變，籌碼就改變。<ul><li>不想扯進這個人，就不要談這個事。</li><li>反過來，要拉這個人進來增加自己的籌碼，就要想辦法談這個事。</li></ul></li></ul><h2 id="談判的籌碼"><a href="#談判的籌碼" class="headerlink" title="談判的籌碼"></a>談判的籌碼</h2><ul><li>籌碼的定義：跟我談他得到什麼（效益），不跟我談他損失什麼（成本）。<ul><li>要增加籌碼，可以選擇「加碼」和「加壓」。</li><li>我有什麼東西是他想要的?<ul><li>金錢、物質、空間、資訊、專業、人力、人脈、通路、能力、行為。</li><li>EX：以「行為」加壓 =&gt; 「要先哭，才能要求不哭給糖」。</li></ul></li></ul></li><li>在「這個時候」跟「這個人」談「這個事」前，記得想想己方有什麼籌碼。<ul><li>時間：錯過他最想要的時間，籌碼就打折了。</li><li>人：他和他的公司（團體）其實角度不會相同。</li><li>事件：談判中的權力是「議題權力」，不是「整體權力」，談不同的事，籌碼不同。</li><li>如果我跟這個人談沒有籌碼，那我認識的人有沒有?</li></ul></li><li>籌碼的使用方式：給他為賞、不給為罰。搭配議題掛勾使用。<ul><li>談 A 事件沒什麼籌碼，但 B、C 有，可以說給我 A 那我給你 B + C。</li><li>反過來，你不給我 A 我就不給你 B、C。</li></ul></li></ul><h2 id="說服的技巧"><a href="#說服的技巧" class="headerlink" title="說服的技巧"></a>說服的技巧</h2><ul><li>怎麼讓對方「想要」我們的「籌碼」。</li><li>從以下角度切入：對錯 （<strong>不要使用</strong>）、利害 （好用）、得失。</li><li>利害<ul><li>EX：從成本效益去剖析「利害」<ul><li>「你」堅持立場的成本很高、「你」堅持立場的效益很低</li><li>「我」堅持立場的成本很高、「我」堅持立場的效益很高 =&gt; 告訴對方我不可能讓步。</li><li>「我」堅持立場的成本很低 =&gt; 告訴對方我可以跟你耗時間。</li></ul></li><li>利害說服的比重：70% 利、30% 害。<ul><li>害為「創造不確定性」，讓對方有無限想像空間。<ul><li>EX：雖然對方銀行利率比較好，但你要把雞蛋都放在同一個籃子裡面嗎?</li></ul></li><li>記得說故事，用故事包裝，讓對方買單。</li></ul></li><li>得失，談判桌上一定要讓對方「覺得」他得的多。<ul><li>談判桌上只能有一個笨蛋，那就是我們自己。如果對方覺得他是那個笨蛋，就沒有下次。</li><li>人的「覺得」很容易控制，人會以中數、中線來判斷自己有沒有談好。</li><li>讓自己讓過中數，我方開 8000、對方 7000，最後 7300 成交，對方覺得賺，但我成本 6000。</li></ul></li></ul></li></ul><h2 id="如何準備談判"><a href="#如何準備談判" class="headerlink" title="如何準備談判"></a>如何準備談判</h2><ul><li>要有足夠的證據支撐我們的立場。<ul><li>進有依據、退也不會讓對方覺得我們示弱。</li></ul></li><li>要創造談判的空間，不要把門鎖死。<ul><li>上桌是談判，不是要東西或投降的，要留點迴旋空間。</li><li>談判不是非黑即白的，否則不可能雙贏。</li><li>對方願意談，除了成本效益分析以外，他必須覺得談判是談的通的。<ul><li>EX：對方說價格能降嗎，我方說可以…但… （Yes, but）</li></ul></li><li>善用方案組合<ul><li>雙方最大化的拿取自己想要的。<ul><li>A 拿到，B、C 就不要。A 沒拿到，就改要 B + C。</li></ul></li><li>談判不要被強迫二選一，Yes、No 可以不接招，改提自己的方案組合。</li></ul></li></ul></li><li>確認談判的時機<ul><li>現在是不是談這件事的最好時候?</li><li>誰比較急、誰有時間等?<ul><li>就算自己比較急，也可以虛張聲勢，假裝自己要的是錢，不要急著掏心掏肺。</li></ul></li></ul></li><li>萬一沒談成，有什麼備案?</li></ul><h2 id="出牌的策略"><a href="#出牌的策略" class="headerlink" title="出牌的策略"></a>出牌的策略</h2><ul><li>先談哪一個?<ol><li>從簡單談起，建立互信。</li><li>有數個議題，可以切割包裝，試探對方要的是什麼，看哪個門是封死的，哪個是虛掩，再從那個議題追下去。</li><li>從最難談起，向對方表示我不會閃避這個問題。</li><li>拼圖法，先談大架構，再填細節。<ul><li>雙方從無到有，展開合作的時候，可以用這種方式開始談。</li></ul></li></ol></li><li>如何出牌?<ul><li>談大的、困難的、重要的議題，可以「硬出牌」、開高。</li><li>談容易的、簡單的，可以「軟出牌」、開低，誘敵深入。</li><li>拼圖式談判，可以選擇「開平」。</li><li>硬出牌：帶目標上桌，提出我想要的，但記得不要把話說死。<ul><li>有行情的話，先出牌、先引導。</li><li>就算不能一下就贏，也能有定錨效果。</li><li>我們對於成交價的期待，經常受到對方開價所操縱。</li><li>不要怕破局，開高走低，先破後立也是談判的戰術。</li><li>達成協議和引爆衝突是不矛盾的。</li><li>談事情:<ul><li>EX：開 A 對方拒絕、換 B 對方拒絕、再 C 對方不好拒絕，成交，但我們的目標本來就是 C。</li><li>閉門羹戰術，等待對方說 No，我再降低，突顯我方善意，以及讓步的上道。</li></ul></li><li>談數字:<ul><li>不能用閉門羹方法，讓對方一直砍價格，下次就只會從砍完的數字再砍。</li><li>要改這樣談<ul><li>原本 1000 直接說成本上漲，要變 1500，讓對方完全無法接受，然後再說，不然王先生，你看這樣好不好，我回去跟老闆爭取一下，爭取 1300 你有辦法接受嗎?</li></ul></li><li>反過來也可以，從 1000 慢慢往上漲，直到對方阻擋，但這樣太慢，不如直接引爆。</li></ul></li></ul></li><li>軟出牌：帶底線上桌，提出我認為他能接受的。<ul><li>讓對方貪圖小利，藉由累積小 Yes，最終收穫大 Yes。 </li></ul></li></ul></li></ul><h2 id="談判桌上的拆招"><a href="#談判桌上的拆招" class="headerlink" title="談判桌上的拆招"></a>談判桌上的拆招</h2><ul><li>對方先出牌的應對方式<ul><li>Yes、No、還價、不回應。</li><li>搞清楚誰有求於誰，可以直接說 No。</li><li>如果我們不想答應，可以不回應、裝死、裝傻。<ul><li>好的沒問題，我會往上呈報，但實際沒有。</li><li>推給人事決策緩慢。</li><li>問 A 答 B 擦邊球。</li></ul></li><li>如果不好拒絕、不回應，可以「還價」，提自己的解決方案 If、No, but…。<ul><li>要小心不要讓出談判桌上的詮釋權。<ul><li>對方開 500，你沒有還價，對方就說，好啦 450，那我讓 50 了，你讓什麼?</li><li>對方開 500 你可以開 200，對方讓，你也可以跟著讓。</li></ul></li><li>要小心假讓步，他拿嘴裡的，換你手裡的。<ul><li>勞資開會，勞方要求加薪 2000，最後 800，但對方實際讓 0。</li></ul></li></ul></li><li>如果必須得說 Yes，得先判斷對方的目的。<ul><li>如果事情對我們不重要，對他可能也不重要，但他卻在這問題上纏鬥。那我們可以在纏鬥幾次後突然答應對方，然後要求對方在另外一個問題上讓步。<ul><li>記得不要在小東西上纏鬥，不要什麼都不讓，這只會讓對方反過來利用。</li></ul></li><li>如果事情對雙方都很重要，對方算準我們不可能讓，但如果我有辦法在戰略上調整，現在可以讓了，這時候可以一下子開門，突然讓給他，破壞他後面的整個戰略設計。</li></ul></li></ul></li><li>讓步的準則：「<strong>幅度遞減、次數少、速度慢</strong>」，讓對方知道你的底線 （不論真假）。<ul><li>幅度遞減：開價 100，100 &gt; 80 &gt; 70 &gt; 65。</li><li>次數少：總共只能讓 3 - 5 次，一次讓 20 萬，和讓 10 次 2 萬，完全不一樣。</li><li>速度慢：不要太早讓步，對方會覺得有詐、你有本錢。不要想著早早讓完，早早回家。往往是早早讓完，就回不了家。</li></ul></li></ul><h2 id="談判的中場戰術"><a href="#談判的中場戰術" class="headerlink" title="談判的中場戰術"></a>談判的中場戰術</h2><ul><li>談判的節奏：開場、中場、收尾。</li><li>談判除了出牌、拆招，但談判的節奏一樣重要。<ul><li>節奏快一點，希望趕快談成。</li><li>節奏慢一點，希望拖一點時間，像是等待新買家出現、等待法案通過。<ol><li>我方人事改變，決策延後。</li><li>議程戰術<ul><li>把原本沒有要談的議程加入。</li><li>議程中間加入一個困難的先決條件，讓對方必須解決這個，才能往下談。</li><li>每次見面，決定下次的談判時間，如果想拖時間，就訂遠一點的日期。</li></ul></li><li>談判技巧<ul><li>黑臉戰術，談判出現一堵牆。<ul><li>EX：100 元，對方殺 90，同意後又殺 85。這時可以說要回去請示一下，隔天和對方說，大哥昨天差點被你騙了，忘記有個數字沒算到，90 沒辦法賣啦，要 95，對方可能說什麼 95 就 90，而且再也不會提 85。</li></ul></li><li>用「小結」節外生枝。<ul><li>小節可以搭配「拖時間」，那我們目前談的議題，雙方決定這樣這樣…，這時候對方可能會突然多出很多意見，就可以重新回去談剛剛那個議題。</li><li>小節可以搭配「鼓勵」，跟對方說，原本有 ABCDE，現在解決了 AB，讓對方覺得談判是有進展的，不會覺得談不動。</li><li>小節可以搭配「澄清」，避免雙方沒共識，但對方出去亂講說雙方有一些共識，導致其他備胎聽到就跑了。所以真的沒共識，可以和對方說，談到現在我們雙方的共識，就是沒共識。</li></ul></li><li>切臘腸戰術，慢慢切，每次給一些讓步。<ul><li>但要記得此戰術的目的是拖時間，和讓步準則想要讓對方知道你的底線是完全不同的目的。</li></ul></li></ul></li></ol></li></ul></li></ul><h2 id="談判的解題模型"><a href="#談判的解題模型" class="headerlink" title="談判的解題模型"></a>談判的解題模型</h2><ul><li>把餅做大：「您有沒有想過，我們可以把一起把餅做大?」<ul><li>向對方表示我方沒有敵意。</li><li>可以引導對方往整合型談判的方向思考。</li><li>注意：想多分一點 =&gt; 就要做大一點，不能反做來講，做大一點 =&gt; 就多分一點。</li></ul></li><li>交集法<ul><li>What do you want?</li><li>看似衝突的情況，真正釐清雙方在乎的需求後，或許能得到一個交集。</li></ul></li><li>掛勾法<ul><li>給我 A，我給你 B、C。</li></ul></li><li>切割法<ul><li>談判的標準動作。</li><li>切的越細，手上的牌越多組合，談判的空間越大。</li></ul></li><li>分解法<ul><li>數個議題，只要談不攏的不是關鍵議題，那就擱置，先達成其他的協議。</li></ul></li><li>階梯法<ul><li>漸進、階段式的談雙方該拿到的利益。</li><li>對雙方最公平，尤其是雙方缺乏互信、對未來認知不同時，可以使用。</li><li>EX：訂單量達到 100，獎金 1%，之後達到 200、獎金 1.5%。</li></ul></li></ul><h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><ul><li>什麼是談判<ul><li>決策：要不要上桌、要不要下桌，都是決策過程。</li><li>思維：怎麼拆招。</li><li>素養：增進比彼此利益。<ul><li>贏者不全贏、輸者不全輸。</li></ul></li></ul></li><li>雙贏<ul><li>談判求雙贏，但<strong>雙贏不等於均分</strong>。</li><li>切割法，彼此都拿一些，每個人贏不同的東西。</li><li>談判必須相信能夠雙贏，才能努力找到任何雙贏的機會。</li><li>「雙贏不會從天上掉下來」，談雙贏都是談輸的人講的，贏的人常常骨子裡想的是獨贏，所以就需要「談判」，找到自己的籌碼，讓對方知道自己也有求於你，願意坐下來談。</li><li>EX：圖書館裡有兩個人坐窗邊，一個怕熱一個怕冷，一個想開窗、另外一個不肯，雙方吵不完，管理員來了，他說隔壁桌還有一個窗戶可以打開，這樣風吹進來，怕熱不至於熱死，怕冷不至於冷死。「<strong>最終是否要開那扇遠窗，難點在於兩位學生是否願意接受這樣的結果，是否願意雙贏，如果有其中一個學生沒有這素養、沒有雙贏的概念，那就破局。</strong>」</li></ul></li><li>談判是讓事情「成為可能」，而不是打仗。<ul><li>談判不能夠有潔癖，不能求全贏，不然往往不能成功任何事。</li><li>怎麼讓事情成為可能，就有某種程度的妥協。</li><li>人們擁有的只是自己的價值觀，沒有人能夠代表真理，而你既然不能壟斷真理，你講的也不必然都對，只是你覺得適合你自己，那就有妥協的空間。</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Relationship </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>玩轉 Fiddler－HTTP(s) 抓包能手 &amp; 常見「特殊」用途</title>
      <link href="2021/08/23/fiddler/"/>
      <url>2021/08/23/fiddler/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>你是否曾經有這些困擾呢?</p><ol><li>戳 API 想要修改前端 Request 送出去的 JSON，但 JS 被 uglify 很難追、或是開 Postman 但要處理認證、授權、和整包 JSON 很麻煩。</li><li>承上，想看的是 UI 與 JS 後續行為，Postman 愛莫能助。</li><li>想測試後端驗證，但前端已經有驗證，想測試還要先拔掉前端驗證的 code。</li><li>在 Local 調整完檔案（HTML、CSS、JS、Image…etc），想上到<strong>正式環境</strong>測試一下效果，但又不想真的改到正式環境的檔案?</li><li>修改 Response 回傳的資料（EX: 修改<strong>後端 API</strong> 回傳的使用者權限、查詢結果、新增成功與否…etc，導致前端畫面上的變化）。</li><li>IDE 都可以下中斷點，不管啦，我的每個 HTTP Request &amp; Response 也要可以下中斷點，即時查看、修改、決定要不要 drop 掉封包。</li></ol><p>如果有任一個需求符合，用 Fiddler 就對了!</p><blockquote><p>PS. 以下文長慎入，可以選擇自己需要的內容閱讀就好。</p></blockquote><h2 id="本文內容："><a href="#本文內容：" class="headerlink" title="本文內容："></a>本文內容：</h2><ol><li>什麼是 Fiddler，和 Postman、Wireshark 的差異?</li><li>實際抓包操作 &amp; 過濾不需要的內容</li><li>設定 AutoResponder 自訂（修改）回傳內容</li><li>中斷每個 Request 或 Response 的方法</li><li>實戰演練，Fiddler 抓不到特定應用程式的封包？</li><li>介紹一些「特殊」的用途（未經許可下，不要做出侵害他人權利之行為）</li></ol><h1 id="什麼是-Fiddler"><a href="#什麼是-Fiddler" class="headerlink" title="什麼是 Fiddler"></a>什麼是 Fiddler</h1><p>老樣子，我們先看<a href="https://zh.wikipedia.org/wiki/Fiddler">維基百科</a>的定義</p><blockquote><p>Fiddler 是一個用於 HTTP 調試的代理伺服器應用程式</p></blockquote><p>也就是說，他能夠抓取並記錄 HTTP 流量，而 HTTPS 也可以利用自簽名證書實現 Man-in-the-middle attack 進行記錄。</p><h2 id="運作流程"><a href="#運作流程" class="headerlink" title="運作流程"></a>運作流程</h2><p><img src="https://i.imgur.com/eC9mrmw.png" alt="Image"></p><p>Client 與 Server 之間的 Request 和 Response 都將經過 Fiddler，由 Fiddler 進行轉發，此時他以代理伺服器的方式存在。</p><p>白話一點來講，可以把圖中的 Fiddler 當成送信的郵差，只要他願意，他可以偷看寄件者寫了什麼東西，甚至是串改信件內容，而收件者回信時，也可以偷看&amp;串改。</p><h2 id="常見工具比較"><a href="#常見工具比較" class="headerlink" title="常見工具比較"></a>常見工具比較</h2><ol><li>Wireshark：擷取各種網路封包，除了 HTTP，也可以看其他協議如 TCP、UDP、Socket…etc。</li><li>Postman：用於調試 API，能夠發送 HTTP 請求與接收回傳結果。</li><li>瀏覽器開發者工具：單純只看 Network 的話，也可以擷取 HTTP Request &amp; Response</li><li>Fiddler：能夠像 Postman 單純發送請求、也可以擷取 HTTP 流量、但是多了一個攔截修改封包的功能</li></ol><p>該用何者工具主要還是要依照當下的需求，如果你只是想看 Request &amp; Response 到底收發了什麼東西，直接 F12 開起來看，簡單快速。</p><p>如果是想要調試 API，雖然 Fiddler 也可以做到，但 UI/UX 與相關功能的完整性，還是 Postman 會好一些。</p><p>如果是要對封包進行截取、重發、編輯等等操作，或是要側錄手機上 APP 的封包，則使用 Fiddler。</p><h2 id="Fiddler-版本"><a href="#Fiddler-版本" class="headerlink" title="Fiddler 版本"></a>Fiddler 版本</h2><p>這邊說的 Fiddler 以及接下來的示範，都會使用 Fiddler Classic 版本。</p><ol><li><p>Fiddler Classic：只能在 Windows 執行，免費使用，功能齊全，但介面對新手比較不友善。<br><img src="https://i.imgur.com/UMDdyXQ.png" alt="Image"></p></li><li><p>Fiddler Everywhere：跨平台，介面友善，一樣能夠修改封包內容，但沒辦法中斷請求以便即時修改，只能設定好 AutoResponder 來修改內容，在 2021/06/29 <a href="https://www.telerik.com/support/whats-new/fiddler-everywhere/release-history">V2.0 發布後</a>，沒有辦法再免費使用（V1.X 是可以免費使用，但也可以付費獲取更多功能）。<br><img src="https://i.imgur.com/UQZgIER.png" alt="Image"></p></li></ol><p>順便提一下歷史背景，2003 年 Fiddler 誕生，在 2012 年被 Telerik 收購，原作者在 2015 年離開 Telerik 跑去 Google，所以 2015 年之後就是由 Telerik 繼續開發，然後 2018 年發布第一版的 Fiddler Everywhere。</p><p>與 Fiddler 相似的抓包工具，還有大名鼎鼎的 BurpSuite（抓包應該只能算他的其中一個功能，他是以測試網路應用程式安全性為主，有興趣的可以去載來玩玩看，有閹割過的免費社群版可以用，喜歡的話也可以購買專業版，只是價格很高就是了，一年 399 美金，而且沒辦法買斷），如果是 Mac 或 Linux 的話可以考慮 Charles（功能和 Fiddler 差不多，只有試用版，期限到了要購買，價格約 50 美金，沒有大版本更新都可以一直使用）</p><p>此處提到軟體的金額以及是否有免費的社群版，以撰文當下時間為主，未來若更新，請以各軟體公告為主。</p><p>若是軟體有幫助到你，而價錢也可以接受的話，與其花時間找其他免費的替代方案，不妨可以直接付費支持，讓作者未來繼續開發新功能。</p><h1 id="實際操作"><a href="#實際操作" class="headerlink" title="實際操作"></a>實際操作</h1><p>講了那麼多，來看一下怎麼使用吧。</p><h2 id="安裝信任憑證-Trust-root-certificate-以擷取-HTTPS-流量"><a href="#安裝信任憑證-Trust-root-certificate-以擷取-HTTPS-流量" class="headerlink" title="安裝信任憑證(Trust root certificate)以擷取 HTTPS 流量"></a>安裝信任憑證(Trust root certificate)以擷取 HTTPS 流量</h2><p>想要抓取 HTTPS 流量的話，要先進行以下設定</p><p><img src="https://i.imgur.com/LpuHmfC.png" alt="Image"></p><p><img src="https://i.imgur.com/tB5aLDi.png" alt="Image"></p><p>接著一路確定，到最後安裝完成就會看到成功的訊息</p><p><img src="https://i.imgur.com/bvu41t9.png" alt="Image"></p><p>其餘設定則維持預設即可</p><p>比較可能會調整到的是預設監聽的 port，如果不想掛在 8866 上，可以自己修改。</p><p><img src="https://i.imgur.com/4sJrxYr.png" alt="Image"></p><h2 id="開始抓包"><a href="#開始抓包" class="headerlink" title="開始抓包"></a>開始抓包</h2><p>可以按 F12，或是左上角的 File &gt; Capture Traffic，或者是點一下左下角紅色框框處(沒有在抓的時候什麼圖案都不會有，但還是可以點一下空白處啟動)，啟動會顯示 Capturing。</p><p><img src="https://i.imgur.com/COFpcwG.png" alt="Image"></p><p>隨意開啟一個網頁，就會看到所有抓到的流量，左半邊是紀錄，點選 Request，可以在右半邊的 Inspectors 看到 Request &amp; Response 細節，包括 Headers、Cookie、Data…etc，其實就和瀏覽器的開發者工具差不多，可以很快上手。</p><p><img src="https://i.imgur.com/hV4x1I7.png" alt="Image"></p><p>對 Request 按右鍵，也可以進行複製、儲存、重送、註解、highlight 等等操作。</p><p><img src="https://i.imgur.com/fy3fJMT.png" alt="Image"></p><p>最上方的選單也有常用功能可以操作，像是如果想清空擷取紀錄，可以點一下 Go 旁邊的那個「X」。</p><p><img src="https://i.imgur.com/UW1OwYH.png" alt="Image"></p><h2 id="過濾"><a href="#過濾" class="headerlink" title="過濾"></a>過濾</h2><p>開始抓包後，應該很快就會有一個困擾，設備上所有 HTTP 流量都會被記錄在上面，雜亂到難以查找，有時候你只是想看一個單一的網站、或是任何 Client 端的程式軟體，如果是這樣的話，可以設定 Filter 規則。</p><p>最基本的設定就是指定 Hosts，多個 Hosts 可以用「;」隔開。</p><p>進階一點的話，可以研究一下 Hosts 區塊下方的選項，像是可以指定哪個 Process 的流量、只顯示符合設定規則的 Request 或 Response、也能夠偵測到特定的 Request 就自動進中斷點（中斷點後面會講）。</p><p><img src="https://i.imgur.com/p9YQNVV.png" alt="Image"></p><h2 id="調試-API"><a href="#調試-API" class="headerlink" title="調試 API"></a>調試 API</h2><p>如果想要像 Postman 那樣發請求，Fiddler 也是可以做到的。</p><p>切換頁籤到 Composer 即可，發送的請求也會出現在左邊區塊的紀錄裡面。</p><p><img src="https://i.imgur.com/IHyd7Eh.png" alt="Image"></p><h1 id="修改封包"><a href="#修改封包" class="headerlink" title="修改封包"></a>修改封包</h1><p>介紹的時候有提到，Fiddler 就像是郵差一樣，可以修改寄件者與收件者的信件內容。</p><p>修改的方式如同 IDE 中斷點一樣，可以決定是要卡住 Request 還是 Response，卡住後可以修改裡面的內容，改完再放行。</p><p>進中斷點（以 Response 為例），可以修改原先預期回傳的內容，不管是 HTML、CSS、JS、JSON 都可以（紅 1），也可以修改回傳的 HTTP Status Code（紅 2），確定後，就點 Run to Completion（紅 3）讓封包繼續傳給 Client 端（EX: Browser）。</p><p><img src="https://i.imgur.com/1p9juay.png" alt="Image"></p><p>除了修改內容或是 HTTP Status Code 以外，Choose Response 最下面有一個「Find a file」，點了之後可以選擇一個 Local 端的檔案，取代掉原本回傳的內容。</p><p>這個在開發測試滿好用的，像是你改了新的一版 JS，Local 簡單測試沒有問題後，想上到正式環境看一下效果，但又怕修改的 JS 有問題，那就可以考慮這種方法，連到正式機的網頁，然後攔截舊版 JS，替換成新的 JS。</p><p><img src="https://i.imgur.com/KWl5dbR.png" alt="Image"></p><h2 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h2><p>如果想要把所有卡住的請求都直接放行，可以點快速功能中的「Go」</p><p><img src="https://i.imgur.com/2HtjTOX.png" alt="Image"></p><h2 id="範例情境"><a href="#範例情境" class="headerlink" title="範例情境"></a>範例情境</h2><p>呼應一下<strong>前言</strong>提到的情境，都是下中斷點可以解決的。</p><p><strong>卡 Request</strong></p><ul><li>戳 API 想要修改前端 Request 送出去的 JSON，但 JS 被 uglify 很難追、或是開 Postman 但要處理認證、授權、和整包 JSON 很麻煩。</li><li>承上，想看的是 UI 與 JS 後續行為，Postman 愛莫能助。</li><li>想測試後端驗證，但前端已經有驗證，想測試還要先拔掉前端驗證的 code。</li></ul><p><strong>卡 Response</strong></p><ul><li>在 Local 調整完檔案（HTML、CSS、JS、Image…etc），想上到<strong>正式環境</strong>測試一下效果，但又不想真的改到正式環境的檔案?</li><li>修改 Response 回傳的資料（EX: 修改<strong>後端 API</strong> 回傳的使用者權限、查詢結果、新增成功與否…etc，導致前端畫面上的變化）。</li></ul><h2 id="中斷點設定方式"><a href="#中斷點設定方式" class="headerlink" title="中斷點設定方式"></a>中斷點設定方式</h2><p>中斷點有以下幾種設定方式：</p><ol><li>Global 層級下中斷點</li><li>設定 AutoResponder</li><li>QuickExec 打指令</li><li>Filter 簡單規則自動進中斷點</li></ol><h3 id="Global-直接開啟-Automatic-breakpoints"><a href="#Global-直接開啟-Automatic-breakpoints" class="headerlink" title="Global 直接開啟 Automatic breakpoints"></a>Global 直接開啟 Automatic breakpoints</h3><p>顧名思義，開啟後所有的 Request 或 Response 都會進入中斷點，在設定好 Filter 不會有太多不相干流量的情況下，也是滿好用的，不用在特別設定什麼規則。</p><p>開啟的方式可以選單點，或是 F11 快捷鍵。</p><p><img src="https://i.imgur.com/n7Z8S2O.png" alt="Image"></p><p><img src="https://i.imgur.com/1s5M74Z.png" alt="Image"></p><p>以 Before Request 為例，勾選後最下面的狀態欄是一個向上的箭頭，代表作用中。</p><p><img src="https://i.imgur.com/gu1BzvL.png" alt="Image"></p><p>也可以點一下，變成 After Response，是一個向下的箭頭（很不明顯XD）。</p><p><img src="https://i.imgur.com/22sLdkA.png" alt="Image"></p><h3 id="設定-AutoResponder"><a href="#設定-AutoResponder" class="headerlink" title="設定 AutoResponder"></a>設定 AutoResponder</h3><p>如果有這些情況，就可以用 AutoResponder。</p><ol><li>不想要無差別卡中斷點，只需要特定的 Request。</li><li>或是自動套用 Response 的修改設定。</li></ol><p>像是上面有提到的替換 JS，總不可能同一個 JS 檔案，每次重新整理網頁後，都要手動再選擇一次。</p><p>所以 AutoResponder 可以理解為，針對某個符合條件的網址，就按照寫好的規則自動修改它的 Response。</p><p><img src="https://i.imgur.com/CJk6e2Q.png" alt="Image"></p><p>設定步驟</p><ol><li>切換到【紅 1】頁籤</li><li>勾選【紅 2】 啟用自訂規則</li><li>勾選【紅 3】很重要！它的意思是沒有符合條件的網址，會直接略過，否則那些不符合條件的請求都會無法送出。</li></ol><p><img src="https://i.imgur.com/N4ti2xc.png" alt="Image"></p><ol start="4"><li>【紅 4】點選添加規則，會在【紅 5】出現，能夠設定的條件如下，可以寫正則式、指定 URL、指定 URL &amp; HTTP Method…etc。</li></ol><p>像是圖中範例，我直接寫一個網址也可以XD</p><p><img src="https://i.imgur.com/WFEDZF0.png" alt="Image"></p><ol start="5"><li>最後就是設定要自動調整的 Response 內容了，和上面提到的差不多，可以選擇回傳的狀態碼，或是是想要回傳自訂檔案的話，點最後的「Find a file」。</li></ol><p><img src="https://i.imgur.com/d8BlxwE.png" alt="Image"></p><p>如果是想要調整 Response 內容的話，點倒數第二個「Create New Response」，然後在跳出的視窗中，編寫你自己需要的 Response Headers、Cookies、JSON…etc。</p><p><img src="https://i.imgur.com/bqh3Yka.png" alt="Image"></p><h4 id="補充-1"><a href="#補充-1" class="headerlink" title="補充"></a>補充</h4><p>如果你在 AutoResponder 想要的是，讓特定的 Request or Response 進中斷點，這也是可以做到的，只要選擇「bpu」或「bpafter」，前者是卡 Request，後者是 Response。這樣只要符合條件的請求，就會如同上面提到的 Global 中斷點那樣，可以即時操作修改。</p><p><img src="https://i.imgur.com/fWb7GzK.png" alt="Image"></p><p>還有些有趣的選項也可以試試看，像是讓特定的請求 delay、drop、redirect。</p><h3 id="QuickExec-打指令"><a href="#QuickExec-打指令" class="headerlink" title="QuickExec 打指令"></a>QuickExec 打指令</h3><p>如果你當下只是要讓特定的 URL 進中斷點 Debug，除了上面提到的 Global 與 AutoResponder 以外，也可以考慮輸入指令的方式。</p><p>還記得上面提到的 <code>bpu</code>、<code>bpafter</code> 嗎?</p><p>其實可以把指令直接打在最下方的黑色框框中（QuickExec）</p><p><img src="https://i.imgur.com/U2Q0kb5.png" alt="Image"></p><p>像是我要卡住指定 URL 的 Request 就可以這樣打，打完按下 Enter</p><p><img src="https://i.imgur.com/RVoe1bB.png" alt="Image"></p><p>就會在右下角出現當前的指令 &amp; URL，如果想要清除指令的話，就再打一次 <code>bpu</code>，然後不要加任何 URL，這樣就能清空上一條指令了。 </p><p><img src="https://i.imgur.com/CbaYuJo.png" alt="Image"></p><h4 id="補充-2"><a href="#補充-2" class="headerlink" title="補充"></a>補充</h4><p>其他支援的指令如下</p><p><img src="https://i.imgur.com/jCD6gvu.png" alt="Image"></p><h1 id="Fiddler-抓不到特定應用程式的封包"><a href="#Fiddler-抓不到特定應用程式的封包" class="headerlink" title="Fiddler 抓不到特定應用程式的封包?"></a>Fiddler 抓不到特定應用程式的封包?</h1><p>到此為止，已經講述了如何配置 Fiddler 抓取 HTTP(s) 流量，並且搭配 Filters 與中斷點，讓開發更加方便。</p><p>預設抓取 <code>All Processes</code> 下，除了 Browser 以外，有些桌面應用程式的流量也有出現在 Fiddler，但有些卻沒有，這是怎麼回事呢?</p><p><img src="https://i.imgur.com/XJbEZbb.png" alt="Image"></p><p><img src="https://i.imgur.com/BAzIWMC.png" alt="Image"></p><p>這是因為除了 Browser 以外，其他能夠抓到的情況是</p><ol><li>程式使用 WinInet 函式庫發送 HTTP/HTTPS</li><li>程式內嵌 WebBrowser</li></ol><p>那如果你還是想要抓某個應用程式，只有兩個辦法</p><ol><li>看一下該應用程式有沒有提供代理伺服器設定<br><img src="https://i.imgur.com/2IHwCj5.png" alt="Image"></li><li>沒有的話只能透過 Proxifier 之類的工具強制代理</li></ol><h2 id="實際演練"><a href="#實際演練" class="headerlink" title="實際演練"></a>實際演練</h2><p>我有購買一個影片，但影片被加密過，要用對方提供的特殊播放器，並且輸入正確的帳號密碼才能夠觀看。</p><p><img src="https://i.imgur.com/gmomyBd.png" alt="Image"></p><p><img src="https://i.imgur.com/QQOn1Q7.png" alt="Image"></p><p>但我遇到一個問題，影片是在本地端，並非線上串流，理論上我應該可以離線（斷網）觀看，但實際把網路關掉後，輸入正確的帳號密碼，卻無法播放，然後打開網路又可以正常播放，除了不方便以外，有時候就算有網路，伺服器還常常連不上…</p><p>至此猜測</p><ol><li>輸入的帳號密碼不會在軟體 Local 端計算解密 Key。</li><li>或者是 Key 是在本地端計算，但可能有其他功能，像是確認軟體版本號之類的，如果無法連上網，就沒辦法播放。</li></ol><p>有了猜想後，來抓包觀察一下，不出所料，什麼都抓不到，而且播放軟體並沒有提供代理設置的功能。</p><p><img src="https://i.imgur.com/gI6WNFf.png" alt="Image"></p><p>那就只能用上面提到的 Proxifier 來強制幫他代理吧！</p><p>PS.</p><ol><li>礙於文章篇幅，不會再介紹 Proxifier 使用方式。</li><li>Proxifier 是要付費的，如果你不想付費，可以尋找其他同類型的工具。</li></ol><p>開啟 Proxifier 設定好規則</p><p><img src="https://i.imgur.com/kGFQD2B.png" alt="Image"></p><p>選擇要代理的應用程式</p><p><img src="https://i.imgur.com/34SMiCa.png" alt="Image"></p><p>接著再重新播放一次影片，可以看到 Fiddler 成功抓到播放器的封包</p><p><img src="https://i.imgur.com/91vlvhY.png" alt="Image"></p><p>在 Response 的 JSON 裡，看到了 <code>play_key</code>，卡了一下中斷點，把其他資料都亂修改，只留下 <code>play_key</code> 還是可以正常播放，因此確定了上面的假設：「軟體是每次播放的時候都拿帳號密碼去戳 Server 取回解密影片的 Key」，但有趣的是，戳了好幾次 Server，每次拿回來的 Key 都一樣XD</p><p><img src="https://i.imgur.com/ZzQ8dIK.png" alt="Image"></p><p>拿到 Key（只對我這部影片有效）之後，就來設定 AutoResponder 規則吧</p><p><img src="https://i.imgur.com/ry0xZCB.png" alt="Image"></p><p>可以直接複製剛剛正常的 Response 貼進來就好</p><p><img src="https://i.imgur.com/Y2rWxu3.png" alt="Image"></p><p>再來可以修改 hosts 讓播放器的網址隨便解析到一個 ip，反正只要連得上，都可以讓他的 Response 變成我們預先設定好的 JSON，如此一來，對方的 Server 不管有沒有啟用，對我們而言都不重要了。</p><h1 id="一些「特殊」的用途"><a href="#一些「特殊」的用途" class="headerlink" title="一些「特殊」的用途"></a>一些「特殊」的用途</h1><p>寫程式常常聽到一句話：「永遠不要相信使用者輸入的內容」，藉由這篇文章，應該更有體會了吧。</p><p>台灣某付費影視網站，曾經發生過只有前端 + API（丟影片 ID 去查） 驗證使用者有沒有權限觀看影片，影片 CDN 資源卻沒有再次驗證，導致修改掉 Request 送出去的影片 ID，就能夠訪問那些使用者無權觀看的影片。</p><p>不只影視網站，其他各式各樣你想的到的網站，可能後端都沒有好好驗，所以身為開發者的我們，請時刻保持警惕，不要心存僥倖。</p><p>說完了網站，那 APP 或桌面應用程式呢?</p><p>網站的每個 Request 很好查看，而 APP 和桌面應用程式乍看之下好像看不到他到底在做什麼，但使用 Fiddler 之類的工具也是原形畢露，有心人也常用來對 APP 進行</p><ol><li>去廣告（EX: 替換掉廣告 URL）</li><li>拿 VIP（EX: <code>&#123; IsVip: false =&gt; true &#125;</code>）</li><li>無限延長試用</li><li>任何 Server 端沒有好好驗的資源…</li></ol><p>除了這些主要功能（資源）放在 Server 端的還能夠阻擋，但如果主要功能（資源）是放在 Client 端的呢?</p><ol><li>某些 APP 的功能本來就在 Client 端實現（EX: 攝影 APP 付費後可以使用進階功能，但這個功能本來就在 APP 裡面，只要搞清楚他是怎麼判斷購買與否的，就無法阻擋。除非弄兩個版本，免費版裡面沒有付費功能，而進階功能要透過 App Stroe 購買才能下載專門的付費版本）</li><li>某速食報報…就不講得太露骨了</li></ol><p>你可能會想說，不會啦，要搞個 APP 還要開電腦抓包修改，太麻煩了。</p><p>但現在 Android、IOS 都有類似 Fiddler 的工具（不止單純抓包，也有 AutoResponder 的功能），連電腦都不用開了。</p><p>IOS 的話我自己是在用 <code>Thor</code>，Android 的話不熟，還請有使用過的人補充。</p><h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>本文提供了一個 Web Debugging Proxy and Troubleshooting Solutions，日後開發遇到困難時，不妨也可以思考看看類似的工具能否幫助你更快排除障礙。</p><p>至於文末提到的那些情境，絕對不是倡導破解與非法存取，而是讓開發者們時刻警惕自己負責的專案有沒有類似問題，若不幸有人閱讀本文後去做出違反法律的事情，也與筆者無關，純屬讀者個人行為。</p>]]></content>
      
      
      <categories>
          
          <category> DevTools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Http Proxy </tag>
            
            <tag> Fiddler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>愛用瀏覽器自動填入? 小心個資外洩!</title>
      <link href="2021/06/20/security-risk-of-autofill/"/>
      <url>2021/06/20/security-risk-of-autofill/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>瀏覽器能夠儲存使用者經常填入的各種資訊，舉凡帳號、密碼、Email、姓名、電話、地址、信用卡資訊…等等。</p><p>帳號密碼可能不一定會儲存，但 Email、姓名、電話之類的個資，應該很多人會選擇讓瀏覽器記憶，避免每次填寫樸實又枯燥乏味的表單要一直重複輸入。</p><p>但是在理解瀏覽器 autocomplete 觸發機制後，你還敢直接填入你的資訊嗎?</p><p>以一個只有 Email 的表單為例，你以為只有填入 Email，實際上所有紀錄的個資，都可以被心懷不軌的網站拿到。</p><p>不囉嗦，直接弄個 Demo 網站看效果: <a href="https://ryanlee.tw/security-risk-of-autofill-demo">https://ryanlee.tw/security-risk-of-autofill-demo</a></p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>瀏覽器儲存的資訊看起來很多，但其實就是三個種類，以 Chrome 為例</p><p><img src="https://i.imgur.com/qYskUcE.png" alt="Image"></p><ol><li><strong>密碼</strong>: 會綁定網站 Domain，只能夠自動填入相同網址下紀錄的帳密，所以不會發生 A 網站登入，卻填入 B 網站的帳密。</li></ol><p><img src="https://i.imgur.com/TrngHLI.png" alt="Image"></p><ol start="2"><li><strong>付款方式</strong>: 儲存信用卡資訊(卡號、到期日、持卡人姓名)，要在 https 的網站下才會觸發自動填入。</li></ol><p><img src="https://i.imgur.com/ft7dDbQ.png" alt="Image"></p><ol start="3"><li>(本文主要討論)<strong>地址和其他資訊</strong>: 國家、郵遞區號、地址、姓名、電話、Email。</li></ol><p><img src="https://i.imgur.com/i10XPqF.png" alt="Image"></p><h2 id="autocomplete"><a href="#autocomplete" class="headerlink" title="autocomplete"></a>autocomplete</h2><p>那站在開發者的角度，該如何讓瀏覽器知道 input 可以填入什麼資訊呢?</p><p>其實很簡單，就設定 input 的 <code>name</code> 或 <code>autocomplete</code> attribute 就好</p><p><img src="https://i.imgur.com/fQ8YXDo.png" alt="Image"></p><p>常見的 attribute 如下(<a href="https://developers.google.com/web/fundamentals/design-and-ux/input/forms">來源</a>):</p><table><thead><tr><th>Content type</th><th>name attribute</th><th>autocomplete attribute</th></tr></thead><tbody><tr><td>Name</td><td>name fname mname lname</td><td>name (full name)、 given-name (first name)、 additional-name (middle name)、 family-name (last name)</td></tr><tr><td>Email</td><td>email</td><td>email</td></tr><tr><td>Address</td><td>address city region province state zip zip2 postal country</td><td>For one address input: street-address、 For two address inputs: address-line1 address-line2、 address-level1 (state or province)、 address-level2 (city)、 postal-code (zip code)、 country</td></tr><tr><td>Phone</td><td>phone mobile country-code area-code exchange suffix ext</td><td>tel</td></tr><tr><td>Credit Card</td><td>ccname cardnumber cvc ccmonth ccyear exp-date card-type</td><td>cc-name cc-number cc-csc cc-exp-month cc-exp-year cc-exp cc-type</td></tr><tr><td>Usernames</td><td>username</td><td>username</td></tr><tr><td>Passwords</td><td>password</td><td>current-password (for sign-in forms)、 new-password (for sign-up and password-change forms)</td></tr></tbody></table><p>具體可看 WHATWG 制定的<a href="https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#autofill">規範</a></p><h2 id="隱藏-input"><a href="#隱藏-input" class="headerlink" title="隱藏 input"></a>隱藏 input</h2><p>文章一開始的 Demo 網站，其實也只是設定好這些屬性，然後把他們「隱藏」起來。</p><p>至於該怎麼隱藏呢?</p><p>如果你試著把 input 設為 <code>display: none</code>、<code>visibility: hidden</code>、<code>input type=&quot;hidden&quot;</code> 這幾種，會發現瀏覽器不會自動填入他們。</p><p>但如果不要這種隱藏，而是調整成只有使用者看不到的那種隱藏，就可以了XD</p><p>把框線隱藏、長寬設為 0(還是會有一小點)、設定 margin 讓他直接超出螢幕。</p><p><img src="https://i.imgur.com/TuwlhcI.png" alt="Image"></p><h2 id="危害範圍"><a href="#危害範圍" class="headerlink" title="危害範圍"></a>危害範圍</h2><p>Chrome、Edge、Safari 當你自動填入個資時，會順便填入所有能夠對應的個人資訊。</p><p>好消息是帳號密碼、付款方式各自獨立，所以不會填入。</p><p>至於 Firefox 也能夠自動填入，但它需要使用者逐個控制項選擇填入，所以不會發生上述問題。</p><p>以 Chrome 為例，根本不知道實際填入了哪些資訊</p><p><img src="https://i.imgur.com/GNmKUGi.png" alt="Image"></p><p>儘管有些瀏覽器可能會顯示實際填入的資訊，但使用者會認真停下來幾秒鐘檢查的又有多少呢?</p><p>又或者，如果有紀錄多個 Email 的情況下，跳出了詳細資訊，大多也會以為瀏覽器顯示詳細訊息，是為了讓你分辨兩筆資料的差別吧…</p><h3 id="市佔率"><a href="#市佔率" class="headerlink" title="市佔率"></a>市佔率</h3><p>以 <a href="(https://netmarketshare.com/browser-market-share.aspx)">Net Applications 調查結果</a>來看</p><p>在 Desktop 下，Chrome 的使用率接近 7 成</p><p><img src="https://i.imgur.com/jP6eZ3O.png" alt="Image"></p><p>在 Mobile 下，Chrome 的使用率也穩居 6 成</p><p><img src="https://i.imgur.com/RSFTsSA.png" alt="Image"></p><p>顯然這個問題影響著很大一部份的使用者。</p><h2 id="防範措施"><a href="#防範措施" class="headerlink" title="防範措施"></a>防範措施</h2><p>那到底該如何避免不想要的資訊被網站拿走呢?</p><ol><li>只在信任的網站自動填入</li><li>乾脆不用自動填入，或是只記錄你覺得洩漏也無所謂的資訊</li><li>使用能夠幫助你檢查表單填入資訊的瀏覽器</li><li>送出表單前，檢查網頁原始碼</li></ol><p>不過最重要的準則還是只有一個，就是「不管帳號密碼、付款方式、個資，都只儲存你覺得洩漏也無所謂的資訊，不要覺得存在瀏覽器裡面很安全，要抱持著它總有一天會洩漏的心態來使用它」。</p>]]></content>
      
      
      <categories>
          
          <category> Security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> browser </tag>
            
            <tag> autofill </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core Model Binding 死活綁不上 - 1</title>
      <link href="2021/05/12/aspnetcore-model-binding/"/>
      <url>2021/05/12/aspnetcore-model-binding/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ASP.NET Core 的 Model Binding 基本上和 ASP.NET Framework 差不多，但實際接觸後，一開始用起來卻卡卡的XD</p><p>本文將紀錄一些當初以為理所當然，結果卻不是這麼一回事的狀況。</p><h2 id="Model-Binding"><a href="#Model-Binding" class="headerlink" title="Model Binding"></a>Model Binding</h2><p>先來科普一下~</p><p>最基本的有三個傳入來源</p><ol><li>Form</li><li>Route</li><li>Query</li></ol><p><img src="https://i.imgur.com/CRzLCcT.png" alt="Image"></p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/3vEzlK2.png"><p>可以三個都傳入，但是有其優先序<br>Form &gt; Route &gt; Query</p><p><img src="https://i.imgur.com/jtdbZzi.png" alt="Image"></p><p>可以看到結果：</p><p>透過 Form 傳入 <code>MyId1 = 1</code><br>透過 Query 參數傳入 <code>MyId1 = 3</code>, <code>MyId2 = 4</code></p><p>因為優先序的關係，MyId1 為 Form 傳入的 <strong>1</strong>，而 MyId2 因為 Form 沒有傳入，所以是吃到 Query 的 <strong>4</strong>。</p><h2 id="Binding-Attributes"><a href="#Binding-Attributes" class="headerlink" title="Binding Attributes"></a>Binding Attributes</h2><p>除了預設的三個來源，其餘皆需設定 Attribute 來指定接收來源。</p><p>但要注意，<strong>一經指定，資料就只能透過指定的方式傳入</strong>。也就是說，如果指定的 Attribute 本來就屬於預設的來源，那傳入 Attribute 指定的來源以外，也無法自動 Binding 上去。 </p><ul><li><p><code>[FromHeader]</code><br>從 HTTP Header 取值。</p></li><li><p><code>[FromForm]</code><br>從 HTTP 的 Form 取值。</p></li><li><p><code>[FromRoute]</code><br>從 MVC Route URL 取值。</p></li><li><p><code>[FromQuery]</code><br>從 URL Query 參數取值。</p></li><li><p><code>[FromBody]</code><br>從 HTTP Body 取值，通常用於取 JSON、XML。</p></li></ul><p>加入的方式可以</p><ol><li>直接在 Action 的參數前面指定</li><li>複雜型別可以到 Model 中的成員加上</li></ol><p><img src="https://i.imgur.com/80gy0XZ.png" alt="Image"></p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/WIS0mNw.png"><p>以上面的例子來說，在 MyId2 指定了 <code>[FromQuery]</code>，那就算在優先序高的 Form 中傳入 <code>MyId2 = 2</code>，也不會被影響到，而是吃 Query 傳入的 <code>MyId2 = 4</code>。</p><p><img src="https://i.imgur.com/c5MHWtF.png" alt="Image"></p><p>Q: 但如果 Query 沒有傳入 MyId2，而是只有 Form 傳入呢?</p><p>A: 如果在沒有指定 Attribute 的情況下，會吃到 Form 傳入的，但如果指定了 <code>[FromQuery]</code>，就算 Form 有傳入，也吃不到。</p><p>下圖可以看到 MyId2 沒吃到，所以回傳 int 預設的 0。</p><p><img src="https://i.imgur.com/3mcptNJ.png" alt="Image"></p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>實際開發時，最頭痛的資料來源就屬 Json 了。</p><p>為什麼頭痛，先來看看下面這個例子…</p><h3 id="複雜型別"><a href="#複雜型別" class="headerlink" title="複雜型別"></a>複雜型別</h3><p>若有兩個 Model A、B</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NameA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NameB &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以 ASP.NET Framework 來說，不管 Ajax ContentType 是 Form 還是 Json，都能夠這樣直接收</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">A a, B b</span>)</span></span><br></pre></td></tr></table></figure><p>但如果是 ASP.NET Core，要接收 Json 需要指定 <code>[FromBody]</code>，否則收不進來</p><p><img src="https://i.imgur.com/xfqZH3L.png" alt="Image"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] A a</span>)</span></span><br></pre></td></tr></table></figure><p>而且 <code>[FromBody]</code> 只能指定到一個參數上面，所以就算這樣寫，也只會把 Value 都嘗試 Bind 到 A 上</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] A a, [FromBody] B b</span>)</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Hpnzwvq.png" alt="Image"></p><h3 id="簡單型別"><a href="#簡單型別" class="headerlink" title="簡單型別"></a>簡單型別</h3><p>簡單型別透過 JSON 也只能帶一個上來</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] <span class="built_in">string</span> strA, [FromBody] <span class="built_in">string</span> strB</span>)</span></span><br></pre></td></tr></table></figure><p>這樣寫一樣綁不上去</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">        strA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        strB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/4mGvj6p.png" alt="Image"></p><p>你以為這樣就綁得上去了嗎?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify&#123;</span><br><span class="line">        strA: <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>因為不符合直接傳 string，所以名字一樣也收不了</p><p><img src="https://i.imgur.com/OcVu3gP.png" alt="Image"></p><p>要直接傳一個 string 才收的到</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(<span class="string">&quot;Bob&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/xmsrSJG.png" alt="Image"></p><p>夠難受吧，如果是多個簡單型別，別用 Json 了，直接發 Form 上來。</p><h2 id="問題-1，接收多個參數"><a href="#問題-1，接收多個參數" class="headerlink" title="問題 1，接收多個參數"></a>問題 1，接收多個參數</h2><p>那如果前端指定 Json，要傳多個參數上來，該怎麼辦呢?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    str: <span class="string">&quot;HiHi&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>把 Action 的 Model 整理成與 Request Data 一致。</p><p>維持使用 <code>[FromBody]</code> 收 JSON 的話，就要把接收的 model 調整成與 Ajax 送上來的格式一致。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">C</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> str &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> A a &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> B b &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">[FromBody] C c</span>)</span></span><br></pre></td></tr></table></figure><h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>接收 Json 只能有一個 <code>[FromBody]</code> 的限制，但 Form 沒有，所以在前端可以改 ContentType、而且你真的懶得再抽一個 Model 時，可以選擇不玩了，直接收 Form 就好XD</p><p>改用 <code>x-www-form-urlencoded</code> 可收多個參數（可以不用加 <code>[FromForm]</code>）。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params"><span class="built_in">string</span> str, A a, B b</span>)</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        str: <span class="string">&quot;HiHi&quot;</span>,</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>Data 的 Key 會自動去 Mapping 可能的 Model 欄位。<br>像是傳入 NameA，則會自動綁到 Model A 的 NameA。</p></blockquote><h2 id="問題-2，x-www-form-urlencoded-同名欄位-or-複雜型別"><a href="#問題-2，x-www-form-urlencoded-同名欄位-or-複雜型別" class="headerlink" title="問題 2，x-www-form-urlencoded 同名欄位 or 複雜型別"></a>問題 2，x-www-form-urlencoded 同名欄位 or 複雜型別</h2><p><code>接收多個參數</code>的問題，如果透過<code>解法二</code>處理，直接改接收 Form，那麼馬上隨之而來會有一個問題。</p><p>「平常印象中 Form 就是簡單的 key-value，沒有辦法帶 Object 格式」</p><h3 id="同名欄位"><a href="#同名欄位" class="headerlink" title="同名欄位"></a>同名欄位</h3><p>先來看看這個，如果兩個 Model 的 Name 一樣…</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSomething</span>(<span class="params">A a, B b</span>)</span></span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">B</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果是傳 Json，可能就會很自然的直接寫</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;AAA&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;BBB&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但 Form 該怎麼帶成上面那樣有階層式的阿…</p><p>如果直接傳兩個 Name 上去，結果會將第一個抓到的 Name 綁到 A 和 B 的 Name 上。</p><p><img src="https://i.imgur.com/VawRThK.png" alt="Image"></p><p>Q: Form 表單的資料格式看起來都是 key = value，該怎麼帶多個同名 key 呢?</p><p>A: 答案是可以這樣寫：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        a[Name]: <span class="string">&quot;AAA&quot;</span>,</span><br><span class="line">        b[Name]: <span class="string">&quot;BBB&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Wk4FQMS.png" alt="Image"></p><h3 id="多個複雜型別"><a href="#多個複雜型別" class="headerlink" title="多個複雜型別"></a>多個複雜型別</h3><p>甚至資料是這樣子呢?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    str: <span class="string">&quot;myStr&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;AAAAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;BBBAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Q: Form 表單的資料格式看起來都是 key = value，該怎麼帶 value 是 object 的資料呢?</p><p>A: 答案是可以這樣寫：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        a[NameA]: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        a[AModel][Address]: <span class="string">&quot;AAAAddress&quot;</span>,</span><br><span class="line">        b[NameB]: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        b[BModel][Address]: <span class="string">&quot;BBBAddress&quot;</span>,</span><br><span class="line">        str: <span class="string">&quot;myStr&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>或是這樣寫（能夠自動匹配的直接傳，同名不能的就指定參數）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel[Address]: <span class="string">&quot;AAAAddress&quot;</span>,</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel[Address]: <span class="string">&quot;BBBAddress&quot;</span>,</span><br><span class="line">        str: <span class="string">&quot;myStr&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h3><p>其實 jQuery 在發 Ajax（<code>x-www-form-urlencoded</code>） 的時候，就會自動把參數組合成上面那樣，你什麼都不用做。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myData = &#123;</span><br><span class="line">    str: <span class="string">&quot;myStr&quot;</span>,</span><br><span class="line">    a: &#123;</span><br><span class="line">        NameA: <span class="string">&quot;Bob&quot;</span>,</span><br><span class="line">        AModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;AAAAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    b: &#123;</span><br><span class="line">        NameB: <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">        BModel: &#123;</span><br><span class="line">            Address: <span class="string">&quot;BBBAdress&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    contentType: <span class="string">&quot;application/x-www-form-urlencoded; charset=utf-8&quot;</span>,</span><br><span class="line">    dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    data: myData</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>送上去的 Form Data 也會是上面範例中的型式</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Du5DHSY.png"><p>後端也能正確解析</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Fxcz1hP.png"><p>補充：如果在送出前就想要拿到這種格式，可以呼叫 <code>param</code> 函數，效果是一樣的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.param(myData)</span><br></pre></td></tr></table></figure><h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>使用了無數次 Ajax，卻不曾停下來看他一眼，趁這次也更清楚 Form 與 Json 的用法差別。</p><p>再來是 ASP.Net Core Model Binding 的資料來源</p><h3 id="ASP-NET-Core-接收-Json"><a href="#ASP-NET-Core-接收-Json" class="headerlink" title="ASP.NET Core 接收 Json"></a>ASP.NET Core 接收 Json</h3><ol><li>一個 Action 只能有一個參數掛 <code>[FromBody]</code></li><li>簡單型別盡量不要用 Json</li><li>多個複雜型別，要再向外抽一個 Model，讓他的格式完全符合前端送上來的 Json 格式</li></ol><h3 id="ASP-NET-Core-接收-Form"><a href="#ASP-NET-Core-接收-Form" class="headerlink" title="ASP.NET Core 接收 Form"></a>ASP.NET Core 接收 Form</h3><ol><li>不會受限於只能有一個參數接收 Form 來源</li><li>多個複雜型別懶得再抽一個 Model，可以考慮用一下</li></ol><p>以上資訊如有錯誤歡迎交流補充~</p><p>下一篇會再提到 ASP.NET Core 接收 Json 還有一些討厭的狀況會讓 Model 綁不上去。</p><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/models/model-binding">Model Binding in ASP.NET Core</a></p>]]></content>
      
      
      <categories>
          
          <category> ASP.NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Model Binding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Net Core Razor View 中文被自動編碼!?</title>
      <link href="2021/04/05/aspnetcore-chinese-encoding/"/>
      <url>2021/04/05/aspnetcore-chinese-encoding/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="View-Engine"><a href="#View-Engine" class="headerlink" title="View Engine"></a>View Engine</h2><p>使用 ASP NET Core MVC 開發時，遇到 HTML 裡的中文被進行編碼，無法正常顯示。</p><p>在找問題成因的時候，出於好奇研究了一下 ASP NET 歷史版本的更新與 View HtmlEncode 的淵源，讓我們把時間倒回 2010 年吧XD</p><p>在 ASP.NET 3.5（MVC 2） 以前，WebForm View Engine 若想要編碼 HTML 中的內容以避免 XSS 問題，需要自己呼叫編碼的方法，但是每個內容都要呼叫實在很麻煩，而且開發者也常常會忘記。</p><p><img src="https://i.imgur.com/RgIcvAq.png" alt="Image"></p><p>所幸 2011 年，ASP.NET 4（MVC 3）發佈以後，新增 <code>&lt;%: %&gt;</code> 語法來自動對內容進行 HTML 編碼，減輕了開發者的負擔與降低系統安全風險。</p><p><img src="https://i.imgur.com/EwN1ni6.png" alt="Image"></p><p>ASP.NET 4（MVC 3）版本中，也 Release 了 Razor View Engine，因為容易學習、寫法更為簡潔方便的特性，使得它逐漸成為開發 ASP.NET MVC 網站的主流（兩者具體比較可以<a href="https://www.c-sharpcorner.com/UploadFile/ff2f08/aspx-view-engine-vs-razor-view-engine/">參考</a>）。</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><h2 id="Net-Framework"><a href="#Net-Framework" class="headerlink" title="Net Framework"></a>Net Framework</h2><p>使用 Razor 在渲染畫面時，會自動進行編碼，防止 XSS。</p><blockquote><p>開發者記得不要在 View 裡面又呼叫 HtmlEncode 進行二次編碼。</p></blockquote><p>簡單來說 cshtml 裡面用到任何後端帶過來的變數，為避免造成 XSS 安全問題，Net Fx 和 Net Core 都會自動對特定符號轉碼。</p><p>EX: <code>&lt; &gt; &#39; &quot;</code></p><p><img src="https://i.imgur.com/OXm9IqG.png" alt="Image"></p><p>以下可以看到測試的結果，特定的字元都被進行轉碼。</p><p><img src="https://i.imgur.com/MmhP191.png" alt="Image"></p><h2 id="Net-Core"><a href="#Net-Core" class="headerlink" title="Net Core"></a>Net Core</h2><p>以上都沒什麼問題，但相同的測試到了 Net Core，好像有些事情不太對勁喔</p><p><img src="https://i.imgur.com/M4miOHk.png" alt="Image"></p><p>輸出的結果</p><p><img src="https://i.imgur.com/KULvD7j.png" alt="Image"></p><p>可以發現到，除了特定的字元以外，連中文都被編碼了，僅剩  abc123 正常顯示。</p><h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><p>翻了一下<a href="https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting#customizing-the-encoders">官方文件</a>真相大白</p><p><img src="https://i.imgur.com/qQH76xd.png" alt="Image"></p><p>原來 ASP.NET Core 的 Razor TagHelper 及 HtmlHelper 預設會將所有非拉丁字元都當成特殊符號進行編碼，理由是為了防範未知或未來瀏覽器針對這些字元渲染時發生的錯誤…</p><p>解決方式也很簡單，放寬預設安全字元的限制就好。</p><p>在 <code>Startup</code> 中的 <code>ConfigureServices</code> 自訂 HtmlEncoder 安全清單，加上 <code>CJK Unified Ideographs</code>。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;HtmlEncoder&gt;(</span><br><span class="line">     HtmlEncoder.Create(allowedRanges: <span class="keyword">new</span>[] &#123; UnicodeRanges.BasicLatin,</span><br><span class="line">                                               UnicodeRanges.CjkUnifiedIdeographs &#125;));</span><br></pre></td></tr></table></figure><blockquote><p>中日韓統一表意文字（英語：CJK Unified Ideographs），也稱統一漢字、統漢碼（英語：Unihan），目的是要把分別來自中文、日文、韓文、越南文、壯文、琉球文中，起源相同、本義相同、形狀一樣或稍異的表意文字，在ISO 10646及萬國碼標準賦予相同編碼。 <a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">from wiki</a></p></blockquote><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting#customizing-the-encoders">Prevent Cross-Site Scripting (XSS) in ASP.NET Core</a></p><p><a href="https://www.c-sharpcorner.com/UploadFile/abhikumarvatsa/html-encoding-in-mvc/">HTML Encoding in MVC</a></p><p><a href="https://www.c-sharpcorner.com/UploadFile/ff2f08/aspx-view-engine-vs-razor-view-engine/">ASPX View Engine VS Razor View Engine</a></p><p><a href="https://weblogs.asp.net/scottgu/new-lt-gt-syntax-for-html-encoding-output-in-asp-net-4-and-asp-net-mvc-2">HTML Encoding Output in ASP.NET 4</a></p><p><a href="https://nwpie.blogspot.com/2017/04/3-aspnet-mvc.html">ASP.NET MVC 演進歷史</a></p><p><a href="https://www.tutorialsteacher.com/mvc/asp.net-mvc-version-history">ASP.NET MVC Version History</a></p>]]></content>
      
      
      <categories>
          
          <category> ASP.NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cshtml </tag>
            
            <tag> encoding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Net Core 多站台共用驗證 Cookie</title>
      <link href="2021/03/10/data-protection-key/"/>
      <url>2021/03/10/data-protection-key/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>當你需要一個安全的機制來保護你的資料時，不妨可以使用 Net Core 的資料保護（Data Protection）。</p><p>他有以下特點：</p><ol><li>容易使用、擴展性高</li><li>基於非對稱的加密機制</li><li>正常情況下，不需要去設定與管理任何密鑰的儲存位置與生命週期</li></ol><p>簡單來說你想加解密資料時，可以直接使用 Data Protection 的 API：</p><ul><li>Protect</li><li>Unprotect</li></ul><p>傻瓜式(?)的使用方式，也避免開發者：</p><ol><li>搞不清楚「對稱、非對稱加密、Hash、編碼」的差異下，選擇了錯誤的方式來保護敏感資料。</li><li>自己造輪子實作加解密…</li></ol><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/introduction">ASP.NET Core 資料保護</a>、<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/using-data-protection">ASP.NET Core 中的資料保護 Api 入門</a></p></blockquote><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>在 Net Framework 時代，透過 MachineKey 來處理 Forms Authentication 的 Cookie 加解密（當然正常情況下也不會去動到 MachineKey，都交由系統處理）。</p><p>而 Net Core 雖沒有 Forms Authentication，但卻有差不多的 Cookie-based Authentication，他的 Cookie 加解密則是由上方提到的 Data Protection 機制來處理。</p><h2 id="問題-多個站台之間無法解密彼此的驗證-Cookie"><a href="#問題-多個站台之間無法解密彼此的驗證-Cookie" class="headerlink" title="問題: 多個站台之間無法解密彼此的驗證 Cookie?"></a>問題: 多個站台之間無法解密彼此的驗證 Cookie?</h2><p>「希望在網站過版時不用停機」</p><p>前陣子碰到這個需求，所以同事多建了一個站台，設定好主站台關閉後網址如何對應到備援的站台（同個網址），然後 Cookie 的 Domain 和有效期限也都有設定好，看起來需求就解決了，但實際測試時，卻有以下問題：</p><ol><li>User 在主站台已經登入的情況下使用系統</li><li>把新程式過版到備援站台</li><li>關閉主站台，讓後續流量都交由備援站台處理</li><li>User 繼續使用系統，卻是沒有登入的狀態，被導到登入畫面</li></ol><p>當下直覺是備援站台無法讀取主站台的 Cookie，後來確認了一下，一半對一半錯XD</p><p>Cookie 是可以讀取的，畢竟是同一個網址，退一步來說就算是相同 Domain 下也會讀取的到，無法讀取的是 Cookie Authentication 的驗證 Cookie。</p><p>顯然地，備援站台因為 Key 不對，無法解開主站台留下的 Cookie，所以問題收斂成需要搞懂：</p><ol><li>Data Protection 的金鑰保存在哪?</li><li>金鑰多久會過期?</li><li>我要怎麼讓不同站台共用金鑰?</li></ol><h1 id="Data-Protection-金鑰管理與生命週期"><a href="#Data-Protection-金鑰管理與生命週期" class="headerlink" title="Data Protection 金鑰管理與生命週期"></a>Data Protection 金鑰管理與生命週期</h1><p>該來的還是得來，啃了官方<del>又香又長</del>的文件。</p><h2 id="金鑰儲存位置"><a href="#金鑰儲存位置" class="headerlink" title="金鑰儲存位置"></a>金鑰儲存位置</h2><p>會依照應用程式的操作環境而有所不同：</p><ol><li>（這裡不討論）在 Azure 上會存在 <code>%HOME%\ASP.NET\DataProtection-Keys</code> 資料夾中</li><li>其餘則是除非有特別設定，否則存放在記憶體</li></ol><p>所以有個滿嚴重的問題，如果 Net Core 專案部屬在 IIS 上，應用程式集區預設的：</p><ol><li>29 小時定期回收</li><li>閒置 20 分自動終止（Terminate）</li></ol><p>或是集區手動回收，都會導致驗證的 Cookie 無法讀取。</p><p>除了驗證 Cookie 以外，只要是該機制加密的東西也會無法讀取，像是 CSRF Token。</p><blockquote><p>補充一下實驗結果，如果集區回收可以接受金鑰遺失，而閒置不想要因為後續行為遺失的話，動作由 Terminate 改為 Suspend（凍結）、或是閒置時間直接改為 0 分鐘（不終止也不凍結），則不會導致記憶體中的金鑰遺失。</p></blockquote><p>所以如果在 IIS 下想要保存金鑰，有<a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/advanced#data-protection">多種</a>設定方式，以下列兩種較方便的設定方式：</p><ol><li>建立 Data Protection Registry keys，將金鑰放在 HKLM 機碼中，並限定該集區的帳戶才能存取。</li><li>(推薦)<br>設定 IIS 應用程式集區載入使用者設定檔，金鑰會存在 <code>%LOCALAPPDATA%\ASP.NET\DataProtection-Keys</code> 資料夾中。</li></ol><h3 id="IIS-應用程式集區載入使用者設定檔"><a href="#IIS-應用程式集區載入使用者設定檔" class="headerlink" title="IIS 應用程式集區載入使用者設定檔"></a>IIS 應用程式集區載入使用者設定檔</h3><p>設定為 True 後，會將金鑰保存到上述的資料夾路徑中，也就是圖中的 xml 檔案。</p><p><img src="https://i.imgur.com/GcX1MKD.png" alt="Image"></p><p><img src="https://i.imgur.com/C7qDfxV.png" alt="Image"></p><p>裡面的內容有：</p><ol><li>建立、啟用、逾期時間（除非特別設定，否則金鑰預設的存活時間是三個月）</li><li>金鑰（在 Windows 平台下會透過 DPAPI 加密）</li></ol><p><img src="https://i.imgur.com/DrhGPLX.png" alt="Image"></p><p><strong>提醒一下，此金鑰和 MachineKey 一樣重要，千萬不能外洩!</strong></p><h1 id="接下來"><a href="#接下來" class="headerlink" title="接下來"></a>接下來</h1><p>了解 Data Protection 的金鑰管理機制後，回頭看我們的問題，還差了那麼一點，因為上面講的是單個集區保存金鑰，但多個集區（正式、備援）依舊是讀取各自保存的金鑰，只是集區回收後金鑰不會遺失而已。</p><p>所以如果要讓多個集區、或是分散式部屬的應用程式能透過 Cookie 達到 SSO 的效果，勢必得把金鑰存到這些應用都能共用的地方。</p><h1 id="自訂金鑰儲存位置"><a href="#自訂金鑰儲存位置" class="headerlink" title="自訂金鑰儲存位置"></a>自訂金鑰儲存位置</h1><p>我們可以指定金鑰存到以下位置：</p><ol><li>Azure Key Vault</li><li>File System</li><li>DB</li></ol><p>請依照專案環境選擇<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview">合適的方式</a>，像是兩個站台都建在同一台 Server 上，可以考慮存到 File System；反之可以存到 DB 比較方便。</p><h2 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h2><p>存到系統上非常簡單，如下配置後，就能夠將上述提到的 xml 存到指定路徑。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddDataProtection()</span><br><span class="line">        .PersistKeysToFileSystem(<span class="keyword">new</span> DirectoryInfo(Configuration[<span class="string">&quot;YourFilePath&quot;</span>]))</span><br><span class="line">        .SetApplicationName(<span class="string">&quot;YourApplicationName&quot;</span>);</span><br><span class="line">        <span class="comment">// 請把所有想要共用同個金鑰的應用程式都指定相同的 Application Name，</span></span><br><span class="line">        <span class="comment">// 不然就算吃到相同的金鑰，也會因為 Net Core 應用程式隔離的特性無法成功加解密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview#per-application-isolation">SetApplicationName 應用程式隔離</a></p></blockquote><h2 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h2><p>Key Storage Providers 也有<a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers">常見的解決方案</a>可以選擇</p><ol><li>Entity Framework Core</li><li>Redis</li></ol><p>這邊選擇透過 EF Core 存到 DB </p><p>寫法如下：</p><ol><li><p>NuGet 下載 <code>Microsoft.AspNetCore.DataProtection.EntityFrameworkCore</code></p></li><li><p>新增一個 DbContext</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyKeysContext</span> : <span class="title">DbContext</span>, <span class="title">IDataProtectionKeyContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// A recommended constructor overload when using EF Core </span></span><br><span class="line">    <span class="comment">// with dependency injection.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyKeysContext</span>(<span class="params">DbContextOptions&lt;MyKeysContext&gt; options</span>) </span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This maps to the table that stores keys.</span></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;DataProtectionKey&gt; DataProtectionKeys &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置連線資訊與指定 PersistKeysToDbContext</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;</span><br><span class="line">        options.UseSqlServer(</span><br><span class="line">            Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add a DbContext to store your Database Keys</span></span><br><span class="line">    services.AddDbContext&lt;MyKeysContext&gt;(options =&gt;</span><br><span class="line">        options.UseSqlServer(</span><br><span class="line">            Configuration.GetConnectionString(<span class="string">&quot;MyKeysConnection&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using Microsoft.AspNetCore.DataProtection;</span></span><br><span class="line">    services.AddDataProtection()</span><br><span class="line">        .PersistKeysToDbContext&lt;MyKeysContext&gt;()</span><br><span class="line">        .SetApplicationName(<span class="string">&quot;YourApplicationName&quot;</span>);</span><br><span class="line">        <span class="comment">// 請把所有想要共用同個金鑰的應用程式都指定相同的 Application Name，不然就算吃到相同的金鑰，也會因為 Net Core 應用程式隔離的特性無法成功加解密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>migration 然後 update database 產生 DataProtectionKeys 的 Table</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add AddDataProtectionKeys --context MyKeysContext</span><br><span class="line">dotnet ef database update --context MyKeysContext</span><br></pre></td></tr></table></figure></li></ol><p>存到 DB 其實只是把 xml 內容存進去而已，沒有做特別改動</p><p><img src="https://i.imgur.com/twJWzAv.png" alt="Image"></p><h2 id="DB-First-解決方法"><a href="#DB-First-解決方法" class="headerlink" title="DB First 解決方法"></a>DB First 解決方法</h2><p>基本上就是這樣，如果有問題的話大概就是第四步，因為我們專案 EF Core 是採 DB First 形式，還是可以解決，只是會有兩種方法：</p><ol><li>可以的話直接 migration 然後 update database，長出 DataProtectionKeys 的 Table 之後，把所有 migration 相關的資料夾、檔案、Table 都刪除。</li><li>如果不能用程式動 Table 的話，可以把 DataProtectionKeys 的 Table 寫成 SQL Script 來給相關人員 Create。</li></ol><p><img src="https://i.imgur.com/48rFEDp.png" alt="Image"></p><p>這邊附上 SQL Server + SSMS 直接產生的 Script，使用前請先確認你使用的 DB 語法有沒有正確。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IF  EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.objects <span class="keyword">WHERE</span> object_id = OBJECT_ID(N<span class="string">&#x27;[dbo].[DataProtectionKeys]&#x27;</span>) <span class="keyword">AND</span> <span class="keyword">type</span> <span class="keyword">in</span> (N<span class="string">&#x27;U&#x27;</span>))</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [dbo].[DataProtectionKeys]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[DataProtectionKeys](</span><br><span class="line">[<span class="keyword">Id</span>] [<span class="built_in">int</span>] <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[FriendlyName] [<span class="keyword">nvarchar</span>](<span class="keyword">max</span>) <span class="literal">NULL</span>,</span><br><span class="line">[<span class="keyword">Xml</span>] [<span class="keyword">nvarchar</span>](<span class="keyword">max</span>) <span class="literal">NULL</span>,</span><br><span class="line"> <span class="keyword">CONSTRAINT</span> [PK_DataProtectionKeys] PRIMARY <span class="keyword">KEY</span> CLUSTERED </span><br><span class="line">(</span><br><span class="line">[<span class="keyword">Id</span>] <span class="keyword">ASC</span></span><br><span class="line">)<span class="keyword">WITH</span> (PAD_INDEX = <span class="keyword">OFF</span>, STATISTICS_NORECOMPUTE = <span class="keyword">OFF</span>, IGNORE_DUP_KEY = <span class="keyword">OFF</span>, ALLOW_ROW_LOCKS = <span class="keyword">ON</span>, ALLOW_PAGE_LOCKS = <span class="keyword">ON</span>) <span class="keyword">ON</span> [PRIMARY]</span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure><h2 id="金鑰加密"><a href="#金鑰加密" class="headerlink" title="!!金鑰加密!!"></a>!!金鑰加密!!</h2><p>只要指定金鑰的儲存位置，不管是存到 File System 還是 DB，Net Core 都不會把金鑰加密，因為他不知道 DPAPI 是否為適當的加密機制，所以如果有改變儲存位置，記得選擇適當的加密方式。</p><ol><li>DPAPI（Windows Only）</li><li>X.509 憑證</li><li>自訂</li></ol><p>若以保存到 File System 為例，XML 打開會看到警示: <code>Warning: the key below is in an unencrypted form.</code>。</p><p><img src="https://i.imgur.com/eMJxVp0.png" alt="Image"></p><blockquote><p>了解更多 <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest">NET Core 的待用金鑰加密</a></p></blockquote><h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>我最後選擇透過 EF Core 將金鑰存到 DB，設定共用的金鑰後，也成功讓正式與備援站台讀取彼此的驗證 Cookie 達到不停機過版的效果，當然未來如果 I/O 遇到效能瓶頸，可能會考慮存到 Redis。</p><p>礙於篇幅與實用性，沒有講到全部的細節，故在文中都有穿插連結，不管是有興趣的人還是想要自己處理金鑰的人，都建議閱讀。</p><p>文中內容若有錯誤的地方，請不吝告知。</p><h1 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview">設定 ASP.NET Core 資料保護</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest">Windows 和 Azure 中使用 ASP.NET Core 的待用金鑰加密</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers">ASP.NET Core 中的金鑰儲存提供者</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/default-settings">ASP.NET Core 中的資料保護金鑰管理和存留期</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/advanced?view=aspnetcore-5.0#data-protection">ASP.NET Core 模組和 IIS 的 Advanced configuration</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cookie-sharing">cookie在 ASP.NET apps 之間共用驗證</a></p><p><a href="https://medium.com/swlh/how-to-distribute-data-protection-keys-with-an-asp-net-core-web-app-8b2b5d52851b">How to distribute Data Protection keys with an ASP.NET Core web app</a></p><p><a href="https://blog.darkthread.net/blog/inside-aspnet-autogenkeys/">ASP.NET MachineKey自動產生原理剖析</a></p><p><a href="https://www.cnblogs.com/savorboard/p/5778616.html">ASP.NET Core 数据保护（Data Protection）【上】</a></p><p><a href="https://www.cnblogs.com/liang24/p/13925057.html">ASP.NET Core Authentication系列（四）基于Cookie实现多应用间单点登录（SSO）</a></p>]]></content>
      
      
      <categories>
          
          <category> ASP.NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Data Protection </tag>
            
            <tag> Cookie </tag>
            
            <tag> SSO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TickTick 待辦事項與行事曆結合 - 基本使用指南</title>
      <link href="2020/12/06/ticktick-startup/"/>
      <url>2020/12/06/ticktick-startup/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>對於待辦事項，之前一直沒有好的方式來管理，最早是嘗試使用行事曆，也就是把待辦事項都當成行程放在裡面，但這會有三個問題:</p><ol><li>有些任務是沒有時間概念、或是急迫性的，也就是什麼時候做都可以</li><li>任務之間會有不同的大分類，Ex: 個人、工作，沒辦法很好的分開他們</li><li>行事曆沒辦法一目瞭然的看到所有 ToDoList，所有任務都和日期格子混在一起，導致時間久了，非常懶得開</li></ol><p>後來有嘗試 Google Keep + Google Calandar，這個其實很接近我想要的管理方式了</p><ol><li>任務都放在 Google Keep 上，很簡單就能夠管理</li><li>有需要時間概念的，就把任務壓上提醒時間</li></ol><p>但這還是有四個問題</p><ol><li>行事曆仍然與待辦事項分開，要用兩個 App</li><li>待辦事項用 Google Keep 有時過於陽春，缺乏良好的管理與搜尋方式</li><li>Google Keep 在 IOS 上的體驗非常不好 (截至 2020/12/06)，每次開啟 App 都會停頓個幾秒，好像是在同步，然後便籤很容易誤觸打開或關閉，拖動 Task 也常常卡頓</li><li>缺乏 Kanban 概念，沒辦法像 Trello 那樣把較複雜的任務，視覺化的拖動來控制任務狀態，Ex: Todo、In Progress、Resolved…</li></ol><p>後來有查了一些熱門的待辦事項解決方案</p><ul><li>Todoist<ul><li>跨平台、訂閱制，免費方案沒有提醒功能</li></ul></li><li>TickTick<ul><li>跨平台、訂閱制，免費方案有提醒功能 + 週行事曆</li></ul></li><li>Trello + 行事曆<ul><li>跨平台、但沒辦法一個 App 搞定</li></ul></li><li>OmniFocus (IOS)<ul><li>功能非常完整，但介面複雜、太麻煩、價格太高</li></ul></li></ul><p>經過簡單評估與試用了 Todoist、TickTick 後，覺得 TickTick 完美符合了我的需求XD</p><p>但 TickTick 有中資背景，會介意的三思</p><h1 id="正文開始"><a href="#正文開始" class="headerlink" title="正文開始"></a>正文開始</h1><p>基本操作就不再介紹了，應該簡單到下載安裝好就會使用，第一次使用也會有新手教學。</p><p>以下會直接以<strong>實際情境</strong>來介紹</p><h2 id="分組"><a href="#分組" class="headerlink" title="分組"></a>分組</h2><p>能夠建立好幾個清單來分開 <strong>個人</strong> 與 <strong>工作</strong> 的待辦事項</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/e00YuXh.jpg"><h2 id="待辦清單"><a href="#待辦清單" class="headerlink" title="待辦清單"></a>待辦清單</h2><p>待辦清單除了標題以外，也可以在補充一些內容，或是子任務</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/3ozLMgr.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/sTqqAME.jpg"><h2 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h2><p>這個有點像心得總結，你可以新增一個非待辦事項的筆記，用來總結一週心得或是任何你想記錄的</p><p>第一張圖片裡面，我就為每個分組都新增了一個 Notes 清單</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/D3Is1fC.jpg"><h2 id="Kanban"><a href="#Kanban" class="headerlink" title="Kanban"></a>Kanban</h2><p>除了條列式的呈現待辦事項以外，也可以切換其他看板模式，達到 Kanban 管理<strong>有狀態</strong>的任務效果。</p><p>我是把 Work 的 List 改成看板而已，因為 Work 的事項有時候比較沒有辦法短時間就完成，但還是要紀錄已經開始處理。</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/MytQ6LZ.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/HHgTNpc.jpg"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/7lbRVWX.jpg"><h2 id="Calendar"><a href="#Calendar" class="headerlink" title="Calendar"></a>Calendar</h2><p>免費版只能使用<strong>週行事曆</strong>而以，需要更詳細的功能可以付費支持。</p><p>行事曆可以一目瞭然的顯示「幾月幾號有什麼事情要做」</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/P0LauKM.jpg"><h3 id="同步其他行事曆"><a href="#同步其他行事曆" class="headerlink" title="同步其他行事曆"></a>同步其他行事曆</h3><p>若有其他行事曆，Ex: iPhone / Google 行事曆，也可以把上面的任務同步進 TickTick</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/YEh5zkQ.jpg"><h2 id="Smart-List"><a href="#Smart-List" class="headerlink" title="Smart List"></a>Smart List</h2><p>上面範例使用了 Work + Personal + Blog 三個清單，若要知道今天或明天總共有哪些待辦事項，不需要每個清單查看，可以到預設的智慧清單查看就好，Ex: 今天、明天、未來 7 天…etc，會幫你統整所有 List 在當天需要做的事情。</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/XdjaPqr.jpg"><h2 id="Desktop"><a href="#Desktop" class="headerlink" title="Desktop"></a>Desktop</h2><p>TickTick 支援: Web、Windows、Mac、IOS、Android</p><p>若在電腦使用，我建議安裝軟體，而不是使用 Webapp，好處有</p><ol><li>可設定開機自動啟動，Webapp 87% 的機率你過一陣子就不會去開他</li><li>提醒方式更加友善</li><li>看板拖拉更直覺</li><li>可設定桌面懸浮</li></ol><p><img src="https://i.imgur.com/VpyDeAb.jpg"></p><p>桌面懸浮可以新增、顯示待辦事項，若不需要使用也會自動縮合在螢幕邊緣，非常實用</p><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/Gvkitkh.png"><img style="max-width: 350px; width: 100%" src="https://i.imgur.com/POKIs05.jpg"><h2 id="附註"><a href="#附註" class="headerlink" title="附註"></a>附註</h2><p>其他還有番茄鐘、打卡養成習慣等功能，若有興趣的也可以自行研究。</p><p>自己是有在電腦使用番茄鐘，還滿方便的，也不用另外在裝軟體或套件，蕃茄鐘也能夠把執行的時間紀錄給某個任務，然後可以到統計圖表查看處理任務花了多少時間。</p><h1 id="碎念"><a href="#碎念" class="headerlink" title="碎念"></a>碎念</h1><p>以上範例都有解決了我的需求</p><ol><li>簡單管理任務</li><li>結合行事曆</li><li>單一 App</li><li>提醒功能</li><li>心得紀錄</li><li>看板功能</li></ol><p>若有類似需求，或是腦袋已經不堪現實的摧殘，需要助手來幫你管理待辦事項的，強力推薦可以嘗試使用XD</p><h2 id="GTD"><a href="#GTD" class="headerlink" title="GTD"></a>GTD</h2><p>如果想要更進階的流程，像是用 GTD（Getting Things Done）的精神來管理，我覺得 TickTick 也是能夠勝任的。</p><p>像是一開始的蒐集階段，TickTick 就有一個收集箱來讓你放</p><ul><li>靈感突發想到的事情，但還不想分類</li><li>瑣碎但還不足以執行的想法</li><li>etc…</li></ul><p>週任務也能夠新增 List 來解決，每週的檢討也能放在 Notes 裡面，這部分就留給讀者自行研究了。</p><p><img src="https://i.imgur.com/753PDvM.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> ToDoList </category>
          
          <category> TickTick </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TickTick </tag>
            
            <tag> ToDoList </tag>
            
            <tag> Kanban </tag>
            
            <tag> Calendar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 建站心得</title>
      <link href="2020/11/30/hexo-note/"/>
      <url>2020/11/30/hexo-note/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>原本以為用 Hexo、挑個 Theme，之後把 Blog 建起來應該不會遇到什麼問題，也不用特別記錄下來，但…事與願違XD</p><h1 id="本文開始"><a href="#本文開始" class="headerlink" title="本文開始"></a>本文開始</h1><p>我用的主題是 <a href="https://github.com/jerryc127/hexo-theme-butterfly">butterfly</a>，理論上只要把裡面文檔都看過就能解決 90% 的問題，也不太需要看<a href="https://hexo.io/zh-tw/docs/">官方文檔</a>，弄好之後放在 Github Page，然後前面掛個 Cloudflare。</p><p>Hexo 大致設定</p><ul><li>Disqus / Facebook Comments</li><li>PWA</li><li>Custom Pagination、Footer</li><li>Edit Scaffolds</li></ul><p>Cloudflare 大致設定</p><ul><li>SSL、Always Use HTTPS、Automatic HTTPS Rewrites</li><li>Auto Minify、Cache、Always Online</li></ul><p>SEO 大致處理</p><ul><li>Sitemap、Robots.txt</li><li>Nofollow</li><li>Submit to Google Search Console</li></ul><p>科普知識就不提了，網路上已經很多詳細的文章</p><ul><li>What ‘s Hexo and Why</li><li>What’s Markdown</li><li>How to deploy to Github Page</li><li>How to use your custom domain and How to buy</li><li>What’s SSL</li><li>etc…</li></ul><p>以下會列出當時有遇到的一些問題。</p><h2 id="Pagination-預設-Style-以圖片為背景"><a href="#Pagination-預設-Style-以圖片為背景" class="headerlink" title="Pagination 預設 Style 以圖片為背景"></a>Pagination 預設 Style 以圖片為背景</h2><p><img src="https://imgur.com/ZciUF7y.png"><br><a href="https://jerryc.me/posts/21cfbf15/">圖片來源</a></p><p>主題預設每個 Post 都會有一個封面圖片，如果不想要可以去設定檔拿掉，但拿掉圖片，上/下一頁連結就變成高度很高，但背景是白的連結了。</p><p>只想要單純的文字，像這樣的話</p><p><img src="https://imgur.com/PfZNzxO.png"></p><p>要直接改 <code>themes\butterfly\layout\includes\pagination.pug</code></p><p>以下節錄我調整後的程式碼，以可以調整成自己喜歡的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if(page.prev)</span><br><span class="line">    - var hasPageNext &#x3D; page.next ? &#39;pull-left&#39; : &#39;pull-full&#39;</span><br><span class="line">    .prev-post(class&#x3D;hasPageNext)</span><br><span class="line">        a(href&#x3D;url_for(page.prev.path))</span><br><span class="line">            .pagination-info</span><br><span class="line">                .i.fa.fa-chevron-circle-left</span><br><span class="line">                .prev_info&#x3D;page.prev.title</span><br><span class="line">          </span><br><span class="line">if(page.next)</span><br><span class="line">    - var hasPagePrev &#x3D; page.prev ? &#39;pull-right&#39; : &#39;pull-full&#39;</span><br><span class="line">    .next-post(class&#x3D;hasPagePrev)</span><br><span class="line">        a(href&#x3D;url_for(page.next.path))</span><br><span class="line">            .pagination-info</span><br><span class="line">                .i.fa.fa-chevron-circle-right</span><br><span class="line">                .next_info&#x3D;page.next.title </span><br></pre></td></tr></table></figure><h2 id="Facebook-Comments"><a href="#Facebook-Comments" class="headerlink" title="Facebook Comments"></a>Facebook Comments</h2><h3 id="超級無敵大雷1"><a href="#超級無敵大雷1" class="headerlink" title="超級無敵大雷1"></a>超級無敵大雷1</h3><p>我網站主題是深色(Dark)，但 FaceBook Comments Dark Theme 目前壞掉，只能透過 CSS 把評論區塊背景設為白色，不然會完全看不到字 (Disqus 沒這個問題)。</p><p><img src="https://imgur.com/zGv7BAv.png"></p><p>看起來和 Hexo 無關，是 Facebook 的問題、也有人 2020/08/12 回報了，雖然進度上寫處理完畢，但我 2020/11/30 測試起來問題仍在。</p><p><a href="https://developers.facebook.com/support/bugs/1759174414250782/">https://developers.facebook.com/support/bugs/1759174414250782/</a></p><p><img src="https://i.imgur.com/6QZkv1C.png"></p><p>不想放棄 Facebook Comments + 深色主題的話，我的解法是把 Facebook 的 Comment 區塊直接背景變白色XD</p><p><code>themes\butterfly\source\css\_layout\comments.styl</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.comment-wrap</span><br><span class="line">    &gt; div:nth-child(2)</span><br><span class="line">        background-color: white !important;</span><br><span class="line">        border-radius: 5px !important;</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/STYzbcG.png"></p><p>而 Disqus 則維持原本正常的深色主題</p><p><img src="https://i.imgur.com/tfiVAJ1.png"></p><h3 id="超級無敵大雷2"><a href="#超級無敵大雷2" class="headerlink" title="超級無敵大雷2"></a>超級無敵大雷2</h3><p>原本以為這樣就高枕無憂，但 2020/11/30 的 IOS 不管是 Chrome 還是 Safari 都無法透過 Facebook Comments 留言，但桌面版、Android 的可以正常留言…</p><p>狀況有2</p><ol><li>明明已經有登入 Facebook，但留言區抓不到，一樣要登入，可是點了登入之後就瘋狂無限白畫面跳轉。</li><li>留言框自己不斷重整，無法選取打字。</li></ol><p>以上問題測試了 3 台 iPhone 都是這樣QQ，一開始以為是我哪裡沒處理好，但到幾個新聞網站 (水果、聯X) 的留言區測試，發現一樣有這些問題…，這個狀況目前無解。</p>]]></content>
      
      
      <categories>
          
          <category> Blog </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Butterfly </tag>
            
            <tag> Facebook Comment </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
